!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Stardust=e():t.Stardust=e()}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var o=e[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=21)}([function(t,e,n){"use strict";function r(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0}),r(n(22)),r(n(12)),r(n(23)),r(n(24))},function(t,e,n){"use strict";function r(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0}),e.version="0.2.4",r(n(0));var o=n(6);e.Specification=o;var i=n(3);e.Intrinsics=i;var a=n(13);e.Compiler=a,r(n(14)),r(n(34)),r(n(41)),r(n(17))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(7);e.compile=function(t){return r.compileString(t)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(0),i=new r.Dictionary,a=[],s=new r.Dictionary,c=new r.Dictionary;function u(t){return"@"+t.name+":"+t.argTypes.join(",")+":"+t.returnType}function l(t){t.internalName=u(t),i.set(t.internalName,t),a.push(t)}function p(t,e,n){var r={name:t,type:e,value:n};c.set(t,r)}function f(t,e,n,r){var o={name:"cast:"+t+":"+e,argTypes:[t],returnType:e,javascriptImplementation:r};l(o),s.set(t+":"+e,{internalName:o.internalName,rank:n})}function h(t,e,n,r){l({name:t,argTypes:e,returnType:n,javascriptImplementation:r})}function d(t,e,n,r){l({name:"@"+t,argTypes:e,returnType:n,javascriptImplementation:r})}function v(){throw new Error("not implemented")}e.getInternalName=u,e.getIntrinsicFunction=function(t){return i.has(t)||console.log(t),i.get(t)},e.forEachIntrinsicFunction=function(t){a.forEach(t)},e.addIntrinsicFunction=l,e.addConstant=p,e.forEachConstant=function(t){c.forEach(t)},e.forEachTypeConversion=function(t){s.forEach(t)},e.getTypeConversion=function(t,e){return s.get(t+":"+e)};var m=function(t,e,n){return h(t,e,t,n)};d("+",["float","float"],"float",function(t,e){return t+e}),d("-",["float","float"],"float",function(t,e){return t-e}),d("*",["float","float"],"float",function(t,e){return t*e}),d("/",["float","float"],"float",function(t,e){return t/e}),d("+",["float"],"float",function(t){return+t}),d("-",["float"],"float",function(t){return-t}),d("%",["int","int"],"int",function(t,e){return t%e}),d("%",["float","float"],"float",function(t,e){return t%e}),d("+",["int","int"],"int",function(t,e){return t+e}),d("-",["int","int"],"int",function(t,e){return t-e}),d("*",["int","int"],"int",function(t,e){return t*e}),d("/",["int","int"],"int",function(t,e){return t/e}),d("+",["int"],"int",function(t){return+t}),d("-",["int"],"int",function(t){return-t}),d("+",["Vector2","Vector2"],"Vector2",function(t,e){return[t[0]+e[0],t[1]+e[1]]}),d("-",["Vector2","Vector2"],"Vector2",function(t,e){return[t[0]-e[0],t[1]-e[1]]}),d("*",["Vector2","Vector2"],"Vector2",function(t,e){return[t[0]*e[0],t[1]*e[1]]}),d("/",["Vector2","Vector2"],"Vector2",function(t,e){return[t[0]/e[0],t[1]/e[1]]}),d("+",["Vector2"],"Vector2",function(t){return t}),d("-",["Vector2"],"Vector2",function(t){return[-t[0],-t[1]]}),d("+",["Vector3","Vector3"],"Vector3",function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2]]}),d("-",["Vector3","Vector3"],"Vector3",function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2]]}),d("*",["Vector3","Vector3"],"Vector3",function(t,e){return[t[0]*e[0],t[1]*e[1],t[2]*e[2]]}),d("/",["Vector3","Vector3"],"Vector3",function(t,e){return[t[0]/e[0],t[1]/e[1],t[2]/e[2]]}),d("+",["Vector3"],"Vector3",function(t){return t}),d("-",["Vector3"],"Vector3",function(t){return[-t[0],-t[1],-t[2]]}),d("+",["Vector4","Vector4"],"Vector4",function(t,e){return[t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3]]}),d("-",["Vector4","Vector4"],"Vector4",function(t,e){return[t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3]]}),d("*",["Vector4","Vector4"],"Vector4",function(t,e){return[t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3]]}),d("/",["Vector4","Vector4"],"Vector4",function(t,e){return[t[0]/e[0],t[1]/e[1],t[2]/e[2],t[3]/e[3]]}),d("+",["Vector4"],"Vector4",function(t){return t}),d("-",["Vector4"],"Vector4",function(t){return[-t[0],-t[1],-t[2],-t[3]]}),d("*",["float","Vector2"],"Vector2",function(t,e){return[t*e[0],t*e[1]]}),d("*",["Vector2","float"],"Vector2",function(t,e){return[t[0]*e,t[1]*e]}),d("*",["Vector2","float"],"Vector2",function(t,e){return[t[0]/e,t[1]/e]}),d("*",["float","Vector3"],"Vector3",function(t,e){return[t*e[0],t*e[1],t*e[2]]}),d("*",["Vector3","float"],"Vector3",function(t,e){return[t[0]*e,t[1]*e,t[2]*e]}),d("*",["Vector3","float"],"Vector3",function(t,e){return[t[0]/e,t[1]/e,t[2]/e]}),d("*",["float","Vector4"],"Vector4",function(t,e){return[t*e[0],t*e[1],t*e[2],t*e[3]]}),d("*",["Vector4","float"],"Vector4",function(t,e){return[t[0]*e,t[1]*e,t[2]*e,t[3]*e]}),d("*",["Vector4","float"],"Vector4",function(t,e){return[t[0]/e,t[1]/e,t[2]/e,t[3]/e]}),d("==",["float","float"],"bool",function(t,e){return t==e?1:0}),d(">",["float","float"],"bool",function(t,e){return t>e?1:0}),d("<",["float","float"],"bool",function(t,e){return t<e?1:0}),d(">=",["float","float"],"bool",function(t,e){return t>=e?1:0}),d("<=",["float","float"],"bool",function(t,e){return t<=e?1:0}),d("==",["int","int"],"bool",function(t,e){return t==e?1:0}),d(">",["int","int"],"bool",function(t,e){return t>e?1:0}),d("<",["int","int"],"bool",function(t,e){return t<e?1:0}),d(">=",["int","int"],"bool",function(t,e){return t>=e?1:0}),d("<=",["int","int"],"bool",function(t,e){return t<=e?1:0}),d("==",["bool","bool"],"bool",function(t,e){return t==e?1:0}),d("!",["bool"],"bool",function(t){return t?0:1}),d("&&",["bool","bool"],"bool",function(t,e){return t&&e?1:0}),d("||",["bool","bool"],"bool",function(t,e){return t||e?1:0}),m("Vector2",["float","float"],function(t,e){return[t,e]}),m("Vector3",["float","float","float"],function(t,e,n){return[t,e,n]}),m("Vector4",["float","float","float","float"],function(t,e,n,r){return[t,e,n,r]}),m("Color",["float","float","float","float"],function(t,e,n,r){return[t,e,n,r]}),m("Quaternion",["float","float","float","float"],function(t,e,n,r){return[t,e,n,r]}),h("abs",["float"],"float",function(t){return Math.abs(t)}),h("sqrt",["float"],"float",function(t){return Math.sqrt(t)}),h("exp",["float"],"float",function(t){return Math.exp(t)}),h("log",["float"],"float",function(t){return Math.log(t)}),h("sin",["float"],"float",function(t){return Math.sin(t)}),h("cos",["float"],"float",function(t){return Math.cos(t)}),h("tan",["float"],"float",function(t){return Math.tan(t)}),h("asin",["float"],"float",function(t){return Math.asin(t)}),h("acos",["float"],"float",function(t){return Math.acos(t)}),h("atan",["float"],"float",function(t){return Math.atan(t)}),h("atan2",["float","float"],"float",function(t,e){return Math.atan2(t,e)}),h("abs",["int"],"int",function(t){return Math.abs(t)}),h("min",["int","int"],"int",function(t,e){return Math.min(t,e)}),h("max",["int","int"],"int",function(t,e){return Math.max(t,e)}),h("min",["float","float"],"float",function(t,e){return Math.min(t,e)}),h("max",["float","float"],"float",function(t,e){return Math.max(t,e)}),h("ceil",["float"],"float",function(t,e){return Math.ceil(t)}),h("floor",["float"],"float",function(t,e){return Math.floor(t)}),h("mix",["float","float","float"],"float",function(t,e,n){return t+(e-t)*n}),h("mix",["Vector2","Vector2","float"],"Vector2",null),h("mix",["Vector3","Vector3","float"],"Vector3",null),h("mix",["Vector4","Vector4","float"],"Vector4",null),h("mix",["Color","Color","float"],"Color",null),h("clamp",["float"],"float",function(t){return Math.max(0,Math.min(1,t))}),h("dot",["Vector2","Vector2"],"float",function(t,e){return t[0]*e[0]+t[1]*e[1]}),h("dot",["Vector3","Vector3"],"float",function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}),h("dot",["Vector4","Vector4"],"float",function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}),h("length",["Vector2"],"float",function(t){return o.Vector2.FromArray(t).normalize().toArray()}),h("length",["Vector3"],"float",function(t){return o.Vector3.FromArray(t).normalize().toArray()}),h("length",["Vector4"],"float",function(t){return o.Quaternion.FromArray(t).normalize().toArray()}),h("length",["Quaternion"],"float",function(t){return o.Quaternion.FromArray(t).normalize().toArray()}),h("normalize",["Vector2"],"Vector2",function(t){return o.Vector2.FromArray(t).length()}),h("normalize",["Vector3"],"Vector3",function(t){return o.Vector3.FromArray(t).length()}),h("normalize",["Vector4"],"Vector4",function(t){return o.Quaternion.FromArray(t).length()}),h("normalize",["Quaternion"],"Quaternion",function(t){return o.Quaternion.FromArray(t).length()}),h("cross",["Vector3","Vector3"],"Vector3",function(t,e){return o.Vector3.FromArray(t).cross(o.Vector3.FromArray(e)).toArray()}),h("quat_mul",["Quaternion","Quaternion"],"Quaternion",function(t,e){return o.Quaternion.FromArray(t).mul(o.Quaternion.FromArray(e)).toArray()}),h("quat_conj",["Quaternion"],"Quaternion",function(t){return o.Quaternion.FromArray(t).conj().toArray()}),h("quat_slerp",["Quaternion","Quaternion","float"],"Quaternion",function(t,e,n){return o.Quaternion.Slerp(o.Quaternion.FromArray(t),o.Quaternion.FromArray(e),n).toArray()}),h("quat_rotate",["Quaternion","Vector3"],"Vector3",function(t,e){return o.Quaternion.FromArray(t).rotate(o.Vector3.FromArray(e)).toArray()}),h("quat_rotation",["Vector3","float"],"Quaternion",function(t,e){return o.Quaternion.Rotation(o.Vector3.FromArray(t),e).toArray()}),m("Color",["float","float","float","float"],function(t,e,n,r){return[t,e,n,r]}),m("Color",["float","float","float"],function(t,e,n){return[t,e,n,1]}),m("Color",["float","float"],function(t,e){return[t,t,t,e]}),m("Color",["float"],function(t){return[t,t,t,1]}),h("lab2rgb",["Color"],"Color",function(t){return t}),h("hcl2rgb",["Color"],"Color",function(t){return t}),f("bool","int",1,function(t){return t}),f("int","float",1,function(t){return t}),h("int",["float"],"int",function(t){return Math.floor(t)}),h("float",["int"],"float",function(t){return t}),f("Quaternion","Vector4",0,function(t){return t}),f("Vector4","Quaternion",0,function(t){return t}),f("Color","Vector4",0,function(t){return t}),f("Vector4","Color",0,function(t){return t}),f("Vector4Array","ColorArray",0,function(t){return t}),f("ColorArray","Vector4Array",0,function(t){return t}),f("Vector4Array2D","Image",0,function(t){return t}),f("Image","Vector4Image",0,function(t){return t}),p("PI","float",Math.PI),p("SQRT2","float",Math.SQRT2),p("SQRT1_2","float",Math.SQRT1_2),p("RED","Color",[1,0,0,1]),h("array",["FloatArray","float"],"float",v),h("array",["Vector2Array","float"],"Vector2",v),h("array",["Vector3Array","float"],"Vector3",v),h("array",["Vector4Array","float"],"Vector4",v),h("array",["ColorArray","float"],"Color",v),h("image",["Image","Vector2"],"Color",v),h("image",["Vector4Image","Vector2"],"Vector4",v),h("image",["Vector3Image","Vector2"],"Vector3",v),h("image",["Vector2Image","Vector2"],"Vector2",v),h("image",["FloatImage","Vector2"],"float",v),h("get_camera_position",[],"Vector3",v),h("get_camera_direction",["Vector3"],"Vector3",v)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(27);e.parseFile=function(t){t=function(t){return t=(t=t.replace(/\/\/[^\n]*\n/g,"\n")).replace(/\/\/[^\n]*$/g,"")}(t);var e=null;try{e=o.parse(t,{startRule:"FileEntry"})}catch(t){throw t.location?new r.ParseError(t.message,t.location.start,t.location.end):new r.ParseError(t.message)}return e},e.parseExpression=function(t){var e=null;try{e=o.parse(t,{startRule:"ExpressionEntry"})}catch(t){throw t.location?new r.ParseError(t.message,t.location.start,t.location.end):new r.ParseError(t.message)}return e}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0);!function(t){t[t.VALUE=0]="VALUE",t[t.FUNCTION=1]="FUNCTION",t[t.TEXTURE=2]="TEXTURE"}(e.BindingType||(e.BindingType={}));var o=function(){return function(t,e){this.name=t,this.offset=e}}();e.ShiftBinding=o,e.getBindingValue=function(t){return t instanceof r.MathType?t.toArray():t},e.types={float:{name:"float",size:4,primitive:"float",primitiveCount:1},int:{name:"int",size:4,primitive:"int",primitiveCount:1},Vector2:{name:"Vector2",size:8,primitive:"float",primitiveCount:2},Vector3:{name:"Vector3",size:12,primitive:"float",primitiveCount:3},Quaternion:{name:"Quaternion",size:16,primitive:"float",primitiveCount:4},Color:{name:"Color",size:16,primitive:"float",primitiveCount:4}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(25);e.Construct=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(0),i=n(3),a=n(26),s=n(4),c=n(30),u=n(31),l=function(){function t(){this._scope=new u.ScopeStack,this._constants=new o.Dictionary,this._moduleResolver=new c.ModuleResolver,this._statements=[],this._lastIndex=1,this.prepareFieldTypeRegistry(),this.prepareConstants()}return t.prototype.prepareFieldTypeRegistry=function(){this._fieldTypeRegistry={};for(var t=this._fieldTypeRegistry,e=0,n=["x","y"];e<n.length;e++){t["Vector2."+n[e]]="float"}for(var r=0,o=["x","y","z","r","g","b"];r<o.length;r++){t["Vector3."+o[r]]="float"}for(var i=0,a=["x","y","z","w","r","g","b","a"];i<a.length;i++){t["Vector4."+a[i]]="float"}for(var s=0,c=["r","g","b","a"];s<c.length;s++){t["Color."+c[s]]="float"}},t.prototype.prepareConstants=function(){var t=this;i.forEachConstant(function(e){t._constants.set(e.name,e)})},t.prototype.resolveFunction=function(t,e,n){var o=this._moduleResolver.getFunction(t);if(o)return o.resolveArguments(e,n);throw new r.CompileError("function '"+t+" is undefined.")},t.prototype.loadFile=function(t){for(var e=this,n=function(t){if("function"==t.type){var n=t;r._moduleResolver.addFunction(n.name,n)}if("import"==t.type){var o=t;if(null!=o.functionNames)o.functionNames.forEach(function(t){e._moduleResolver.importFunction(a.getModule(o.moduleName),t)});else{var i=a.getModule(o.moduleName);i.forEach(function(t,n){e._moduleResolver.importFunction(i,n)})}}},r=this,o=0,i=t.blocks;o<i.length;o++){n(i[o])}},t.prototype.getDefaultValueForType=function(t){return"float"==t?0:"Vector2"==t?[0,0]:"Vector3"==t?[0,0,0]:"Vector4"==t?[0,0,0,0]:"Color"==t?[0,0,0,1]:"Quaternion"==t?[0,0,0,1]:0},t.prototype.compileFunctionToMark=function(t,e){this._scope.resetScope(),this._lastIndex=1;for(var n={},o={},i={},a=0,s=t;a<s.length;a++){var c=s[a];this._scope.addVariable(c.name,c.valueType,"global"),n[c.name]={type:c.valueType,default:c.default||this.getDefaultValueForType(c.valueType)}}for(var u=0,l=e.arguments;u<l.length;u++){var p=l[u];this._scope.addVariable(p.name,p.type,"local"),n[p.name]={type:p.type,default:p.default||this.getDefaultValueForType(p.type)}}this.compileStatements({type:"statements",statements:e.statements}),this._scope.forEach(function(t,e){n[t]||(i[t]=e)});var f=function(t){t.forEach(function(t){if("emit"==t.type){var e=t;for(var n in e.attributes)if(o.hasOwnProperty(n)){if(o[n].type!=e.attributes[n].valueType)throw new r.CompileError("output variable '"+n+" has conflicting types.")}else o[n]={type:e.attributes[n].valueType}}if("condition"==t.type){var i=t;f(i.trueStatements),f(i.falseStatements)}"for"==t.type&&f(t.statements)})};return f(this._statements),{input:n,output:o,variables:i,statements:this._statements}},t.prototype.addStatement=function(t){this._statements.push(t)},t.prototype.addStatements=function(t){this._statements=this._statements.concat(t)},t.prototype.captureStatements=function(t){var e=this._statements;this._statements=[],t();var n=this._statements;return this._statements=e,n},t.prototype.compileExpression=function(t){switch(t.type){case"value":return{type:"constant",value:(e=t).value,valueType:e.valueType};case"variable":var e=t;if(this._constants.has(e.name)){var n=this._constants.get(e.name);return{type:"constant",value:n.value,valueType:n.type}}return{type:"variable",variableName:this._scope.translateVariableName(e.name),valueType:this._scope.getVariable(e.name).type};case"field":e=t;var r=this.compileExpression(e.value);return{type:"field",fieldName:e.fieldName,value:r,valueType:this._fieldTypeRegistry[r.valueType+"."+e.fieldName]};case"function":for(var i=[],a={},s=0,c=(e=t).args.args;s<c.length;s++){var u=c[s];i.push(this.compileExpression(u))}for(var l in e.args.kwargs){e.args.kwargs[l];a[l]=this.compileExpression(e.args.kwargs[l])}var p=this.resolveFunction(e.name,i,a),f=p[0],h=p[1],d=null;if(f.statements){var v=new o.Dictionary;for(var m in f.arguments){u=f.arguments[m];var _=this._scope.nextVariableName(u.type);v.set(u.name,_),this.addStatement({type:"assign",variableName:this._scope.translateVariableName(_),expression:h[m]})}this._scope.pushScope(v),this._moduleResolver.enterFunctionImplementation(e.name);for(var y=0,g=f.statements;y<g.length;y++){var x=g[y];if("return"==x.type){var b=x;d=this.compileExpression(b.value);break}this.compileStatement(x)}this._moduleResolver.leaveFunctionImplementation(e.name),this._scope.popScope()}else d={type:"function",functionName:f.name,arguments:h,valueType:f.returnType};return d}return null},t.prototype.compileStandaloneExpression=function(t,e){switch(t.type){case"value":return{type:"constant",value:(n=t).value,valueType:n.valueType};case"variable":var n=t;if(e.has(n.name))return e.get(n.name);if(this._constants.has(n.name)){var o=this._constants.get(n.name);return{type:"constant",value:o.value,valueType:o.type}}throw new r.CompileError("variable "+n.name+" is undefined");case"field":n=t;var i=this.compileStandaloneExpression(n.value,e);return{type:"field",fieldName:n.fieldName,value:i,valueType:this._fieldTypeRegistry[i.valueType+"."+n.fieldName]};case"function":for(var a=[],s={},c=0,u=(n=t).args.args;c<u.length;c++){var l=u[c];a.push(this.compileStandaloneExpression(l,e))}for(var p in n.args.kwargs){n.args.kwargs[p];s[p]=this.compileStandaloneExpression(n.args.kwargs[p],e)}var f=this.resolveFunction(n.name,a,s),h=f[0],d=f[1];return{type:"function",functionName:h.name,arguments:d,valueType:h.returnType}}return null},t.prototype.compileStatements=function(t){this._scope.pushScope();for(var e=0,n=t.statements;e<n.length;e++){var r=n[e];this.compileStatement(r)}this._scope.popScope()},t.prototype.compileStatement=function(t){var e=this;switch(t.type){case"declare":if((a=t).initial){var n=this.compileExpression(a.initial),o=a.variableType;if("auto"==o&&(o=n.valueType),this._scope.addVariable(a.variableName,o,"local"),n.valueType!=o){var i=n.valueType;if(null===(n=c.typeConversionAttempt(n,this._scope.getVariable(a.variableName).type)[0]))throw new r.CompileError("cannot convert type '"+i+"' to '"+o+"'.")}this.addStatement({type:"assign",variableName:this._scope.translateVariableName(a.variableName),expression:n})}else this._scope.addVariable(a.variableName,a.variableType,"local");break;case"expression":var a=t;this.compileExpression(a.expression);break;case"assign":a=t,n=this.compileExpression(a.expression);var s=this._scope.getVariable(a.variableName).type;if(n.valueType!=s){i=n.valueType;if(null===(n=c.typeConversionAttempt(n,this._scope.getVariable(a.variableName).type)[0]))throw new r.CompileError("cannot convert type '"+i+" to '"+s+"'.")}this.addStatement({type:"assign",variableName:this._scope.translateVariableName(a.variableName),expression:n});break;case"emit":(a=t).vertices.forEach(function(t){var n={};for(var r in t){var o=t[r];n[r]=e.compileExpression(o)}e.addStatement({type:"emit",attributes:n})});break;case"discard":this.addStatement({type:"discard"});break;case"statements":a=t;this.compileStatements(a);break;case"for":var u=t;this._scope.pushScope(),this._scope.addVariable(u.variableName,"int","local");var l={type:"for",variableName:this._scope.translateVariableName(u.variableName),rangeMin:u.start,rangeMax:u.end,statements:this.captureStatements(function(){return e.compileStatement(u.statement)})};this.addStatement(l),this._scope.popScope();break;case"if":var p=t,f=function(t){if(t<p.conditions.length){e._scope.pushScope();var n={type:"condition",condition:e.compileExpression(p.conditions[t].condition),trueStatements:e.captureStatements(function(){return e.compileStatement(p.conditions[t].statement)}),falseStatements:e.captureStatements(function(){return f(t+1)})};e.addStatement(n),e._scope.popScope()}else p.else&&e.compileStatement(p.else)};f(0);break;case"return":throw new r.CompileError("unexpected return statement")}},t}();function p(t){for(var e={},n=t.blocks.filter(function(t){return"global"==t.type}),r=0,o=t.blocks;r<o.length;r++){var i=o[r];if("function"==i.type){var a=i;if(a.isMark||a.isShader){var s=new l;s.loadFile(t);var c=s.compileFunctionToMark(n,a);e[a.name]=c}}}return e}e.Compiler=l,e.compileTree=p;var f=new l;e.compileExpression=function(t,e){return f.compileStandaloneExpression(t,e)},e.compileString=function(t){return p(s.parseFile(t))}},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(5),a=function(){return function(){}}();e.TextureBinding=a;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._data=null,e._valueFunction=null,e._dirty=!1,e._textureData=null,e}return o(e,t),e.prototype.getTextureData=function(){if(this._dirty){var t=this._data.map(this._valueFunction).map(i.getBindingValue);if(0==t.length)this._textureData=null;else{var e,n=void 0;if("number"==typeof t[0]){n=1,e=new Float32Array(4*t.length);for(var r=0;r<t.length;r++)e[4*r]=t[r]}else{n=t[0].length,e=new Float32Array(4*t.length);var o=0;for(r=0;r<t.length;r++){for(var a=t[r],s=0;s<n;s++)e[o++]=a[s];o+=4-n}}this._textureData={width:this._data.length,height:1,dimensions:1,type:"f32",numberComponents:n,data:e}}}return this._textureData},e.prototype.data=function(t){return null!=t?(this._data=t,this._dirty=!0,this):this._data},e.prototype.value=function(t){return null!=t?(this._valueFunction=t,this._dirty=!0,this):this._valueFunction},e}(a);e.ArrayBinding=s;var c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._data=null,e}return o(e,t),e.prototype.setImage=function(t){this._data={width:t.width,height:t.height,numberComponents:4,type:t instanceof HTMLImageElement?"HTMLImageElement":"HTMLCanvasElement",data:t,dimensions:2}},e.prototype.getTextureData=function(){return this._data},e}(a);e.Image=c,e.array=function(){return new s}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(0),i=n(15),a=n(10),s=[{shift:-2,suffix:"_pp"},{shift:-1,suffix:"_p"},{shift:1,suffix:"_n"},{shift:2,suffix:"_nn"}],c=function(){function t(t,e,n){for(var r in this._spec=t,this._shader=e,this._data=[],this._platform=n,this._bindings=new o.Dictionary,this._shiftBindings=new o.Dictionary,this._platformMark=null,this._shouldUploadData=!0,this._instanceFunctions=null,this._spec.input)if(this._spec.input.hasOwnProperty(r)){var a=this._spec.input[r];null!=a.default&&this._bindings.set(r,new i.Binding(a.type,a.default))}for(var c in this._spec.input)if(this._spec.input.hasOwnProperty(c))for(var u=0,l=s;u<l.length;u++){var p=l[u],f=p.shift,h=p.suffix;this._spec.input.hasOwnProperty(c+h)&&(this._bindings.delete(c+h),this._shiftBindings.set(c+h,new i.ShiftBinding(c,f)))}}return Object.defineProperty(t.prototype,"spec",{get:function(){return this._spec},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),t.prototype.attr=function(t,e){if(void 0===e){if(!this._bindings.has(t))throw new r.RuntimeError("attr '"+t+" is undefined.");var n=this._bindings.get(t);return n instanceof i.Binding?n.value:n}if(!this._spec.input.hasOwnProperty(t))throw new r.RuntimeError("attr '"+t+" is undefined.");if(e instanceof a.ScaleBinding)this._platformMark&&this._bindings.get(t)!=e&&(this._platformMark=null),this._bindings.set(t,e);else{var o=new i.Binding(this._spec.input[t].type,e);this._platformMark&&(this._platformMark.isUniform(t)&&o.bindingType!=i.BindingType.FUNCTION?(o.bindingType==i.BindingType.VALUE&&this._platformMark.updateUniform(t,o.specValue),o.bindingType==i.BindingType.TEXTURE&&this._platformMark.updateTexture(t,o.textureValue)):this._platformMark=null),this._bindings.set(t,o)}return this},t.prototype.data=function(t){return void 0===t?this._data:(this._data=t,this._shouldUploadData=!0,this)},t.prototype.instance=function(t,e){if(void 0===t&&void 0===e)return this._instanceFunctions;this._instanceFunctions={datum:t,attrs:e}},t.prototype.prepareSpecification=function(){var t={input:o.shallowClone(this._spec.input),output:this._spec.output,statements:this._spec.statements.slice(),variables:o.shallowClone(this._spec.variables),repeatBegin:this._spec.repeatBegin,repeatEnd:this._spec.repeatEnd},e=this._bindings.clone(),n=this._shiftBindings.clone();return this._bindings.forEach(function(r,o){if(r instanceof a.ScaleBinding){var c=r.getAttributes(),u={};c.forEach(function(n){var r=o+n.bindedName;e.set(r,new i.Binding(n.type,n.binding)),u[n.bindedName]={type:"variable",valueType:n.type,variableName:r},t.input[r]={type:n.type,default:null}}),t.variables[o]=t.input[o].type,t.statements.splice(0,0,{type:"assign",variableName:o,expression:r.getExpression(u),valueType:t.input[o].type});for(var l=function(a,s){if(t.input.hasOwnProperty(o+a)){t.variables[o+a]=t.input[o].type;var u={};c.forEach(function(r){var c=o+r.bindedName;if(e.get(c).bindingType==i.BindingType.FUNCTION){var l=c+a;n.set(l,new i.ShiftBinding(c,s)),u[r.bindedName]={type:"variable",valueType:r.type,variableName:l},t.input[l]={type:r.type,default:null}}else u[r.bindedName]={type:"variable",valueType:r.type,variableName:c}}),t.statements.splice(0,0,{type:"assign",variableName:o+a,expression:r.getExpression(u),valueType:t.input[o].type})}},p=0,f=s;p<f.length;p++){var h=f[p];l(m=h.suffix,h.shift)}delete t.input[o],e.delete(o);for(var d=0,v=s;d<v.length;d++){var m=v[d].suffix;n.has(o+m)&&(delete t.input[o+m],n.delete(o+m))}}}),[t,e,n]},t.prototype.uploadScaleUniforms=function(){var t=this;this._bindings.forEach(function(e,n){if(e instanceof a.ScaleBinding){e.getAttributes().forEach(function(e){e.binding instanceof i.TextureBinding?t._platformMark.updateTexture(n+e.bindedName,e.binding):t._platformMark.updateUniform(n+e.bindedName,e.binding)})}})},t.prototype.prepare=function(){var t=this;if(!this._platformMark){var e=this.prepareSpecification(),n=e[0],r=e[1],o=e[2];this._platformMark=this._platform.compile(this,n,this._shader,r,o),this._shouldUploadData=!0}if(this._shouldUploadData){if(null==this._instanceFunctions)this._platformMarkData=this._platformMark.uploadData([this._data]);else{var i=[];this._data.forEach(function(e,n){var r=t._instanceFunctions.datum(e,n,t._data);i.push(r)}),this._platformMarkData=this._platformMark.uploadData(i)}this._shouldUploadData=!1}return this},t.prototype.render=function(){var t=this;return this.prepare(),null==this._instanceFunctions?this._platformMark.render(this._platformMarkData,function(){t.uploadScaleUniforms()}):this._platformMark.render(this._platformMarkData,function(e){var n=t._data[e];if(t._instanceFunctions.attrs){var r=t._instanceFunctions.attrs(n,e,t._data);if(null!=r)for(var o in r)r.hasOwnProperty(o)&&t._platformMark.updateUniform(o,i.getBindingValue(r[o]))}t.uploadScaleUniforms()}),this},t}();e.Mark=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){for(var r=[],o=3;o<arguments.length;o++)r[o-3]=arguments[o];this._scale=t,this._returnType=e,this._argTypes=n,this._args=r}return t.prototype.getReturnType=function(){return this._returnType},t.prototype.getAttributes=function(){for(var e=this,n=[],r=0,o=this._scale.getAttributes();r<o.length;r++){var i=o[r];n.push({scaleBinding:this,bindedName:"s"+i.name,name:i.name,type:i.type,binding:i.binding})}return this._args.forEach(function(r,o){if(r instanceof t)for(var i=0,a=r.getAttributes();i<a.length;i++){var s=a[i];n.push({scaleBinding:e,bindedName:"a"+o+s.bindedName,name:s.name,type:s.type,binding:s.binding})}else n.push({scaleBinding:e,bindedName:"a"+o,name:"a"+o,type:e._argTypes[o],binding:r})}),n},t.prototype.getExpression=function(e){for(var n,r={},o=0,i=this._scale.getAttributes();o<i.length;o++){var a=i[o];r[a.name]=e["s"+a.name]}var s=this._args.map(function(n,r){if(n instanceof t){for(var o={},i=0,a=n.getAttributes();i<a.length;i++){var s=a[i];o[s.bindedName]=e["a"+r+s.bindedName]}return n.getExpression(o)}return e["a"+r]});return(n=this._scale).getExpression.apply(n,[r].concat(s))},t}();e.ScaleBinding=r},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),a=n(1),s=n(43),c=n(1),u=n(1),l=n(47),p=function(){function t(t,e,n,r,o,i){this._GL=t;var c=new s.Generator(e,n,r,o,i);this._program=l.compileProgram(this._GL,c.getVertexCode(),c.getFragmentCode()),this._uniformLocations=new a.Dictionary,this._attribLocations=new a.Dictionary,this._textures=new a.Dictionary,this._currentTextureUnit=0}return t.prototype.use=function(){this._GL.useProgram(this._program)},t.prototype.setUniform=function(t,e,n){var r=this.getUniformLocation(t);if(null!=r){var o=this._GL;if("float"==e.primitive){var i=n;switch(e.primitiveCount){case 1:o.uniform1f(r,n);break;case 2:o.uniform2f(r,i[0],i[1]);break;case 3:o.uniform3f(r,i[0],i[1],i[2]);break;case 4:o.uniform4f(r,i[0],i[1],i[2],i[3])}}if("int"==e.primitive){i=n;switch(e.primitiveCount){case 1:o.uniform1i(r,n);break;case 2:o.uniform2i(r,i[0],i[1]);break;case 3:o.uniform3i(r,i[0],i[1],i[2]);break;case 4:o.uniform4i(r,i[0],i[1],i[2],i[3])}}}},t.prototype.setTexture=function(t,e){var n=this._GL;if(!this._textures.has(t)){var r=n.createTexture(),o=this._currentTextureUnit++;this._textures.set(t,{data:null,texture:r,unit:o}),n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.bindTexture(n.TEXTURE_2D,null),this.use(),this.setUniform(t,i.types.int,o)}var a=this._textures.get(t),s=e.getTextureData();if(a.data!=s){switch(a.data=s,n.bindTexture(n.TEXTURE_2D,a.texture),s.type){case"f32":case"u8":n.texImage2D(n.TEXTURE_2D,0,n.RGBA,s.width,s.height,0,n.RGBA,n.FLOAT,s.data);break;case"HTMLImageElement":case"HTMLCanvasElement":n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.FLOAT,s.data)}n.bindTexture(n.TEXTURE_2D,null),this.use(),1==s.dimensions&&this.setUniform(t+"_length",i.types.float,s.width),2==s.dimensions&&(this.setUniform(t+"_width",i.types.float,s.width),this.setUniform(t+"_height",i.types.float,s.height))}},t.prototype.bindTextures=function(){var t=this._GL;this._textures.forEach(function(e){t.activeTexture(t.TEXTURE0+e.unit),t.bindTexture(t.TEXTURE_2D,e.texture)})},t.prototype.unbindTextures=function(){var t=this._GL;this._textures.forEach(function(e){t.activeTexture(t.TEXTURE0+e.unit),t.bindTexture(t.TEXTURE_2D,null)})},t.prototype.getUniformLocation=function(t){if(this._uniformLocations.has(t))return this._uniformLocations.get(t);var e=this._GL.getUniformLocation(this._program,t);return this._uniformLocations.set(t,e),e},t.prototype.getAttribLocation=function(t){if(this._attribLocations.has(t))return this._attribLocations.get(t);var e=this._GL.getAttribLocation(this._program,t);return e<0&&(e=null),this._attribLocations.set(t,e),e},t}(),f=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return o(e,t),e}(i.PlatformMarkData);e.WebGLPlatformMarkData=f;var h=function(t){function e(e,n,r,o,i,c,u){var l=t.call(this)||this;l._platform=e,l._GL=n,l._mark=r,l._bindings=c,l._shiftBindings=u,l._spec=o,l._shader=i;var f=a.Compiler.Transforms.flattenEmits(o);return l._specFlattened=f.specification,l._flattenedVertexIndexVariable=f.indexVariable,l._flattenedVertexCount=f.count,l._program=new p(n,l._specFlattened,l._shader,function(t){return l.isUniform(t)},l._platform.viewInfo.type,s.GenerateMode.NORMAL),l._programPick=new p(n,l._specFlattened,l._shader,function(t){return l.isUniform(t)},l._platform.viewInfo.type,s.GenerateMode.PICK),l.initializeUniforms(),l}return o(e,t),e.prototype.initializeUniforms=function(){for(var t in this._specFlattened.input)if(this.isUniform(t)){var e=this._bindings.get(t);e.bindingType==i.BindingType.VALUE&&this.updateUniform(t,e.specValue),e.bindingType==i.BindingType.TEXTURE&&this.updateTexture(t,e.textureValue)}},e.prototype.initializeBuffers=function(){var t=this,e=this._GL,n=new f;return n.buffers=new a.Dictionary,this._bindings.forEach(function(r,o){t.isUniform(o)||null!=t._program.getAttribLocation(o)&&n.buffers.set(o,e.createBuffer())}),n.buffers.set(this._flattenedVertexIndexVariable,e.createBuffer()),this._programPick&&n.buffers.set("s3_pick_index",e.createBuffer()),n.ranges=[],n},e.prototype.isUniform=function(t){if(t==this._flattenedVertexIndexVariable)return!1;if(null==this._bindings.get(t)){if(null==this._shiftBindings.get(t))throw new c.RuntimeError("attribute "+t+" is not specified.");return this._bindings.get(this._shiftBindings.get(t).name).bindingType!=i.BindingType.FUNCTION}return this._bindings.get(t).bindingType!=i.BindingType.FUNCTION},e.prototype.updateUniform=function(t,e){var n=this._bindings.get(t).valueType;this._program.use(),this._program.setUniform(t,n,e),this._programPick&&(this._programPick.use(),this._programPick.setUniform(t,n,e))},e.prototype.updateTexture=function(t,e){this._program.setTexture(t,e),this._programPick&&this._programPick.setTexture(t,e)},e.prototype.uploadData=function(t){var e=this.initializeBuffers();e.ranges=[];var n=this._spec.repeatBegin||0,r=this._spec.repeatEnd||0,o=this._GL,i=(this._bindings,this._flattenedVertexCount),a=0;t.forEach(function(t){var o=t.length;if(0!=o){var s=a,c=a+=o+n+r;e.ranges.push([s*i,c*i])}else e.ranges.push(null)}),this._bindings.forEach(function(s,c){var u=e.buffers.get(c);if(null!=u){var l=s.valueType,p=new Float32Array(l.primitiveCount*a*i),f=0,h=l.primitiveCount*i;t.forEach(function(t){if(0!=t.length){for(var e=0;e<n;e++)s.fillBinary([t[0]],i,p.subarray(f,f+h)),f+=h;s.fillBinary(t,i,p.subarray(f,f+t.length*h)),f+=t.length*h;for(e=0;e<r;e++)s.fillBinary([t[t.length-1]],i,p.subarray(f,f+h)),f+=h}}),o.bindBuffer(o.ARRAY_BUFFER,u),o.bufferData(o.ARRAY_BUFFER,p,o.STATIC_DRAW)}});for(var s=new Float32Array(a*i),c=0;c<a*i;c++)s[c]=c%i;if(o.bindBuffer(o.ARRAY_BUFFER,e.buffers.get(this._flattenedVertexIndexVariable)),o.bufferData(o.ARRAY_BUFFER,s,o.STATIC_DRAW),this._programPick){var u=new Float32Array(a*i*4);for(c=0;c<a*i;c++){var l=Math.floor(c/i);u[4*c+0]=(255&l)/255,u[4*c+1]=((65280&l)>>8)/255,u[4*c+2]=((16711680&l)>>16)/255,u[4*c+3]=((4278190080&l)>>24)/255}o.bindBuffer(o.ARRAY_BUFFER,e.buffers.get("s3_pick_index")),o.bufferData(o.ARRAY_BUFFER,u,o.STATIC_DRAW)}return e},e.prototype.renderBase=function(t,e,n){var r=this;if(t.ranges.length>0){var o=this._GL,i=this._specFlattened,a=this._bindings,c=this._program;e==s.GenerateMode.PICK&&(c=this._programPick),c.use();var u=0,l=0;for(var p in this._shiftBindings.forEach(function(t,e){t.offset>l&&(l=t.offset),t.offset<u&&(u=t.offset)}),i.input){if(null!=(d=c.getAttribLocation(p)))if(this._shiftBindings.has(p)){var f=this._shiftBindings.get(p);o.bindBuffer(o.ARRAY_BUFFER,t.buffers.get(f.name)),o.enableVertexAttribArray(d);var h=a.get(f.name).valueType;o.vertexAttribPointer(d,h.primitiveCount,"float"==h.primitive?o.FLOAT:o.INT,!1,0,h.size*(f.offset-u)*this._flattenedVertexCount)}else if(o.bindBuffer(o.ARRAY_BUFFER,t.buffers.get(p)),o.enableVertexAttribArray(d),p==this._flattenedVertexIndexVariable)o.vertexAttribPointer(d,1,o.FLOAT,!1,0,4*-u*this._flattenedVertexCount);else{h=a.get(p).valueType;o.vertexAttribPointer(d,h.primitiveCount,"float"==h.primitive?o.FLOAT:o.INT,!1,0,h.size*-u*this._flattenedVertexCount)}}if(e==s.GenerateMode.PICK){var d=c.getAttribLocation("s3_pick_index");o.bindBuffer(o.ARRAY_BUFFER,t.buffers.get("s3_pick_index")),o.enableVertexAttribArray(d),o.vertexAttribPointer(d,4,o.FLOAT,!1,0,0)}var v=this._platform.viewInfo,m=this._platform.pose,_=this._platform.cameraPosition;switch(v.type){case s.ViewType.VIEW_2D:o.uniform4f(c.getUniformLocation("s3_view_params"),2/v.width,-2/v.height,-1,1);break;case s.ViewType.VIEW_3D:o.uniform4f(c.getUniformLocation("s3_view_params"),1/Math.tan(v.fovY/2)/v.aspectRatio,1/Math.tan(v.fovY/2),(v.near+v.far)/(v.near-v.far),2*v.near*v.far/(v.near-v.far)),m?(o.uniform4f(c.getUniformLocation("s3_view_rotation"),m.rotation.x,m.rotation.y,m.rotation.z,m.rotation.w),o.uniform3f(c.getUniformLocation("s3_view_position"),m.position.x,m.position.y,m.position.z)):(o.uniform4f(c.getUniformLocation("s3_view_rotation"),0,0,0,1),o.uniform3f(c.getUniformLocation("s3_view_position"),0,0,0)),o.uniform3f(c.getUniformLocation("s3_camera_position"),_.x,_.y,_.z);break;case s.ViewType.VIEW_MATRIX:o.uniformMatrix4fv(c.getUniformLocation("s3_view_matrix"),!1,v.viewMatrix),o.uniformMatrix4fv(c.getUniformLocation("s3_projection_matrix"),!1,v.projectionMatrix),m?(o.uniform4f(c.getUniformLocation("s3_view_rotation"),m.rotation.x,m.rotation.y,m.rotation.z,m.rotation.w),o.uniform3f(c.getUniformLocation("s3_view_position"),m.position.x,m.position.y,m.position.z)):(o.uniform4f(c.getUniformLocation("s3_view_rotation"),0,0,0,1),o.uniform3f(c.getUniformLocation("s3_view_position"),0,0,0)),o.uniform3f(c.getUniformLocation("s3_camera_position"),_.x,_.y,_.z)}for(var y in e==s.GenerateMode.PICK&&o.uniform1f(c.getUniformLocation("s3_pick_index_alpha"),this._pickIndex/255),c.bindTextures(),t.ranges.forEach(function(t,e){n&&n(e),null!=t&&(c.use(),c.bindTextures(),o.drawArrays(o.TRIANGLES,t[0],t[1]-t[0]-(l-u)*r._flattenedVertexCount))}),c.unbindTextures(),i.input){null!=(d=c.getAttribLocation(y))&&o.disableVertexAttribArray(d)}if(e==s.GenerateMode.PICK){d=c.getAttribLocation("s3_pick_index");o.disableVertexAttribArray(d)}}},e.prototype.setPickIndex=function(t){this._pickIndex=t},e.prototype.render=function(t,e){this._platform.renderMode==s.GenerateMode.PICK&&this.setPickIndex(this._platform.assignPickIndex(this._mark)),this.renderBase(t,this._platform.renderMode,e)},e}(i.PlatformMark);e.WebGLPlatformMark=h;var d=function(t){function e(e){var n=t.call(this)||this;return n._GL=e,n.set2DView(500,500),n.setCameraPosition(new i.Vector3),n.setPose(new u.Pose),n._renderMode=s.GenerateMode.NORMAL,n._pickFramebuffer=null,n}return o(e,t),Object.defineProperty(e.prototype,"viewInfo",{get:function(){return this._viewInfo},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pose",{get:function(){return this._pose},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cameraPosition",{get:function(){return this._cameraPosition},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"renderMode",{get:function(){return this._renderMode},enumerable:!0,configurable:!0}),e.prototype.getPickFramebuffer=function(t,e){if(null==this._pickFramebuffer||t!=this._pickFramebufferWidth||e!=this._pickFramebufferHeight){var n=this._GL;this._pickFramebuffer=n.createFramebuffer(),this._pickFramebufferWidth=t,this._pickFramebufferHeight=e,n.bindFramebuffer(n.FRAMEBUFFER,this._pickFramebuffer),this._pickFramebufferTexture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this._pickFramebufferTexture),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t,e,0,n.RGBA,n.UNSIGNED_BYTE,null),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this._pickFramebufferTexture,0),n.bindTexture(n.TEXTURE_2D,null),n.bindFramebuffer(n.FRAMEBUFFER,null)}return this._pickFramebuffer},e.prototype.beginPicking=function(t,e){this._renderMode=s.GenerateMode.PICK;var n=this._GL,r=this.getPickFramebuffer(t,e);n.bindFramebuffer(n.FRAMEBUFFER,r),n.clearColor(1,1,1,1),n.clear(n.COLOR_BUFFER_BIT),n.disable(n.BLEND),this._pickMarks=[]},e.prototype.assignPickIndex=function(t){var e=this._pickMarks.indexOf(t);if(e>=0)return e;var n=this._pickMarks.length;return this._pickMarks.push(t),n},e.prototype.endPicking=function(){var t=this._GL;t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.BLEND),this._renderMode=s.GenerateMode.NORMAL},e.prototype.getPickingPixel=function(t,e){if(null==this._pickMarks||t<0||e<0||t>=this._pickFramebufferWidth||e>=this._pickFramebufferHeight)return null;var n=this._GL,r=this._pickFramebuffer;n.bindFramebuffer(n.FRAMEBUFFER,r);var o=new Uint8Array(4);n.readPixels(t,this._pickFramebufferHeight-1-e,1,1,n.RGBA,n.UNSIGNED_BYTE,o),n.bindFramebuffer(n.FRAMEBUFFER,null);var i=o[0]+(o[1]<<8)+(o[2]<<16);return i>=16777215?null:[this._pickMarks[o[3]],i]},e.prototype.set2DView=function(t,e){this._viewInfo={type:s.ViewType.VIEW_2D,width:t,height:e}},e.prototype.set3DView=function(t,e,n,r){void 0===n&&(n=.1),void 0===r&&(r=1e3),this._viewInfo={type:s.ViewType.VIEW_3D,fovY:t,aspectRatio:e,near:n,far:r}},e.prototype.setWebVRView=function(t,e){this._viewInfo={type:s.ViewType.VIEW_MATRIX,viewMatrix:t,projectionMatrix:e}},e.prototype.setMatrixView=function(t,e){this._viewInfo={type:s.ViewType.VIEW_MATRIX,viewMatrix:t,projectionMatrix:e}},e.prototype.setCameraPosition=function(t){this._cameraPosition=t},e.prototype.setPose=function(t){this._pose=t},e.prototype.compile=function(t,e,n,r,o){return new h(this,this._GL,t,e,n,r,o)},e}(i.Platform);e.WebGLPlatform=d},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(){return function(){}}();e.MathType=i;var a=function(t){function e(e,n){void 0===e&&(e=0),void 0===n&&(n=0);var r=t.call(this)||this;return r.x=e,r.y=n,r}return o(e,t),e.FromArray=function(t){return new e(t[0],t[1])},e.prototype.clone=function(){return new e(this.x,this.y)},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y)},e.prototype.sub=function(t){return new e(this.x-t.x,this.y-t.y)},e.prototype.mul=function(t){return new e(this.x*t.x,this.y*t.y)},e.prototype.div=function(t){return new e(this.x/t.x,this.y/t.y)},e.prototype.scale=function(t){return new e(this.x*t,this.y*t)},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},e.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);return new s(this.x/t,this.y/t)},e.prototype.toArray=function(){return[this.x,this.y]},e}(i);e.Vector2=a;var s=function(t){function e(e,n,r){void 0===e&&(e=0),void 0===n&&(n=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.x=e,o.y=n,o.z=r,o}return o(e,t),e.FromArray=function(t){return new e(t[0],t[1],t[2])},e.prototype.clone=function(){return new e(this.x,this.y,this.z)},e.prototype.add=function(t){return new e(this.x+t.x,this.y+t.y,this.z+t.z)},e.prototype.sub=function(t){return new e(this.x-t.x,this.y-t.y,this.z-t.z)},e.prototype.mul=function(t){return new e(this.x*t.x,this.y*t.y,this.z*t.z)},e.prototype.div=function(t){return new e(this.x/t.x,this.y/t.y,this.z/t.z)},e.prototype.scale=function(t){return new e(this.x*t,this.y*t,this.z*t)},e.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.prototype.cross=function(t){return new e(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},e.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);return new e(this.x/t,this.y/t,this.z/t)},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e}(i);e.Vector3=s;var c=function(t){function e(e,n,r,o){void 0===e&&(e=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=0);var i=t.call(this)||this;return i.x=e,i.y=n,i.z=r,i.w=o,i}return o(e,t),e.Slerp=function(t,n,r){var o=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;o>1&&(o=1),o<-1&&(o=-1);var i,a,s=Math.acos(o);if(Math.abs(s)<1e-10)i=1-r,a=r;else{var c=Math.sin(s);i=Math.sin((1-r)*s)/c,a=Math.sin(r*s)/c}return new e(t.x*i+n.x*a,t.y*i+n.y*a,t.z*i+n.z*a,t.w*i+n.w*a)},e.Rotation=function(t,n){var r=t.normalize().scale(Math.sin(n/2));return new e(r.x,r.y,r.z,Math.cos(n/2))},e.FromArray=function(t){return new e(t[0],t[1],t[2],t[3])},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.conj=function(){return new e(-this.x,-this.y,-this.z,this.w)},e.prototype.mul=function(t){return new e(t.x*this.w+this.x*t.w+this.y*t.z-this.z*t.y,t.y*this.w+this.y*t.w+this.z*t.x-this.x*t.z,t.z*this.w+this.z*t.w+this.x*t.y-this.y*t.x,this.w*t.w-this.x*t.x-this.y*t.y-this.z*t.z)},e.prototype.rotate=function(t){var n=new e(t.x,t.y,t.z,0),r=this.mul(n).mul(this.conj());return new s(r.x,r.y,r.z)},e.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return new e(this.x/t,this.y/t,this.z/t,this.w/t)},e.prototype.slerp=function(t,n){return e.Slerp(this,t,n)},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e}(i);e.Quaternion=c;var u=function(){function t(t,e){void 0===t&&(t=new s(0,0,0)),void 0===e&&(e=new c(0,0,0,1)),this.position=t,this.rotation=e}return t.prototype.transform=function(t){return this.rotation.rotate(t).add(this.position)},t.prototype.transformDirection=function(t){return this.rotation.rotate(t)},t.prototype.concat=function(e){return new t(this.rotation.rotate(e.position).add(this.position),this.rotation.mul(e.rotation))},t.prototype.invert=function(){var e=this.rotation.conj();return new t(e.rotate(this.position).scale(-1),e)},t}();e.Pose=u},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(7);e.compileExpression=r.compileExpression,e.compileString=r.compileString,e.compileTree=r.compileTree,e.Compiler=r.Compiler;var o=n(4);e.parseExpression=o.parseExpression,e.parseFile=o.parseFile;var i=n(32);e.Transforms=i},function(t,e,n){"use strict";function r(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0}),r(n(15)),r(n(8)),r(n(5))},function(t,e,n){"use strict";function r(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0});var o=n(8),i=n(0),a=n(5);r(n(5)),r(n(8));var s=function(){function t(t,e){this._type=a.types[t],this._value=e}return Object.defineProperty(t.prototype,"valueType",{get:function(){return this._type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"value",{get:function(){return this._value},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bindingType",{get:function(){return this._value instanceof o.TextureBinding?a.BindingType.TEXTURE:"function"==typeof this._value?a.BindingType.FUNCTION:a.BindingType.VALUE},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"specValue",{get:function(){return a.getBindingValue(this._value)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textureValue",{get:function(){return this._value},enumerable:!0,configurable:!0}),t.prototype.forEach=function(t,e){switch(this.bindingType){case a.BindingType.FUNCTION:for(var n=this._value,r=0;r<t.length;r++)e(a.getBindingValue(n(t[r],r)),r);break;case a.BindingType.VALUE:var o=a.getBindingValue(this._value);for(r=0;r<t.length;r++)e(o,r);break;case a.BindingType.TEXTURE:throw new i.RuntimeError("Texture binding does not support for each")}},t.prototype.map=function(t){switch(this.bindingType){case a.BindingType.FUNCTION:var e=this._value;return t.map(function(t,n){return a.getBindingValue(e(t,n))});case a.BindingType.VALUE:var n=a.getBindingValue(this._value);return t.map(function(){return n});case a.BindingType.TEXTURE:throw new i.RuntimeError("Texture binding does not support for map")}},t.prototype.fillBinary=function(t,e,n){var r=t.length,o=this._type.primitiveCount,s=0;switch(this.bindingType){case a.BindingType.FUNCTION:var c=this._value;if(1==o)for(var u=0;u<r;u++)for(var l=a.getBindingValue(c(t[u],u)),p=0;p<e;p++)n[s++]=l;else for(u=0;u<r;u++)for(l=a.getBindingValue(c(t[u],u)),p=0;p<e;p++)for(var f=0;f<o;f++)n[s++]=l[f];break;case a.BindingType.VALUE:var h=a.getBindingValue(this._value);if(1==o){var d=h;for(u=0;u<r;u++)for(p=0;p<e;p++)n[s++]=d}else for(d=h,u=0;u<r;u++)for(p=0;p<e;p++)for(f=0;f<o;f++)n[s++]=d[f];break;case a.BindingType.TEXTURE:throw new i.RuntimeError("Texture binding does not support for fillBinary")}},t}();e.Binding=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(13),i=function(){function t(t){this._name=t,this._attrs=new r.Dictionary}return t.prototype.attr=function(t,e){return this._attrs.set(t,e),this},t.prototype.generateCode=function(){var t=[];return this._attrs.forEach(function(e,n){t.push(n+" = "+e)}),this._name+"("+t.join(", ")+")"},t}();e.CustomMarkItem=i;var a=function(){function t(){this._imports=[],this._inputs=[],this._variables=[],this._items=[]}return t.prototype.input=function(t,e,n){return this._inputs.push([t,e,n]),this},t.prototype.variable=function(t,e){return this._variables.push([t,e]),this},t.prototype.add=function(t){for(var e=t.split("."),n=e[0],r=e[1],o=!1,a=0,s=this._imports;a<s.length;a++){var c=s[a],u=c[0],l=c[1];u==n&&l==r&&(o=!0)}o||this._imports.push([n,r]);var p=new i(r);return this._items.push(p),p},t.prototype.generateCode=function(t){for(var e=[],n=0,r=this._imports;n<r.length;n++){var o=r[n],i=o[0],a=o[1];e.push("import { "+a+" } from "+i+";")}for(var s=[],c=0,u=this._inputs;c<u.length;c++){var l=u[c],p=l[0],f=l[1],h=l[2];null==h?s.push(p+": "+f):s.push(p+": "+f+" = "+h)}e.push("mark "+t+"("),e.push("    "+s.join(", ")),e.push(") {");for(var d=0,v=this._variables;d<v.length;d++){var m=v[d],_=m[0],y=m[1];e.push("    let "+_+" = "+y+";")}for(var g=0,x=this._items;g<x.length;g++){var b=x[g];e.push("    "+b.generateCode()+";")}return e.push("}"),e.join("\n")},t.prototype.compile=function(){var t=this.generateCode("Mark");return o.compileString(t).Mark},t}();e.CustomMark=a},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),a=function(){return function(){}}();e.PlatformMarkData=a;var s=function(){return function(){}}();e.PlatformMark=s;var c=function(){return function(){}}();e.Viewport=c;var u=function(t){function e(e,n){var r=t.call(this)||this;return r.width=e,r.height=n,r}return o(e,t),e}(c);e.Viewport2D=u;var l=function(t){function e(e,n,r){var o=t.call(this)||this;return o.width=e,o.height=n,o.fov=r,o}return o(e,t),e}(c);e.Viewport3D=l;var p=new i.Dictionary,f=function(){function t(){}return t.Register=function(t,e){p.set(t,e)},t.Create=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return p.get(t).apply(void 0,e)},t}();e.Platform=f,e.platform=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return f.Create.apply(f,[t].concat(e))}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(2);e.basic=function(){return r.compile("\n        shader Default(\n            color: Color = [ 0, 0, 0, 1 ]\n        ) {\n            emit { color: color };\n        }\n    ").Default},e.lighting=function(){return r.compile("\n        shader Default(\n            color: Color = [ 0, 0, 0, 1 ],\n            normal: Vector3,\n            position: Vector3\n        ) {\n            let lighting = get_camera_direction(position);\n            let NdotL = abs(dot(normal, lighting));\n            let s = NdotL * 0.5 + 0.5;\n            emit { color: Color(s * color.r, s * color.g, s * color.b, color.a) };\n        }\n    ").Default}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.version="0.2.4";var r=n(11);e.WebGLPlatform=r.WebGLPlatform;var o=n(20);e.WebGLCanvasPlatform2D=o.WebGLCanvasPlatform2D,e.WebGLCanvasPlatform3D=o.WebGLCanvasPlatform3D,e.WebGLCanvasPlatformWebVR=o.WebGLCanvasPlatformWebVR;var i=n(1),a=n(11),s=n(20);i.Platform.Register("webgl",function(t){return new a.WebGLPlatform(t)}),i.Platform.Register("webgl-2d",function(t,e,n){return void 0===e&&(e=600),void 0===n&&(n=400),new s.WebGLCanvasPlatform2D(t,e,n)}),i.Platform.Register("webgl-3d",function(t,e,n){return void 0===e&&(e=600),void 0===n&&(n=400),new s.WebGLCanvasPlatform3D(t,e,n)}),i.Platform.Register("webgl-webvr",function(t,e,n){return void 0===e&&(e=600),void 0===n&&(n=400),new s.WebGLCanvasPlatformWebVR(t,e,n)})},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(1),a=n(11),s=n(48),c=function(t){function e(e,n,r){void 0===n&&(n=600),void 0===r&&(r=400);var o=this,i=e.getContext("webgl")||e.getContext("experimental-webgl");try{i.getExtension("OES_texture_float"),i.getExtension("OES_texture_float_linear")}catch(t){}return(o=t.call(this,i)||this)._canvas=e,i.clearColor(1,1,1,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.disable(i.DEPTH_TEST),i.enable(i.BLEND),i.disable(i.CULL_FACE),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),o._pixelRatio=s.getDefaultDevicePixelRatio(),o.resize(n,r),o}return o(e,t),Object.defineProperty(e.prototype,"pixelRatio",{get:function(){return this._pixelRatio},set:function(t){this._pixelRatio=t,this.resize(this._width,this._height)},enumerable:!0,configurable:!0}),e.prototype.resize=function(t,e){this._width=t,this._height=e,this._canvas.style.width=t+"px",this._canvas.style.height=e+"px",this._canvas.width=t*this._pixelRatio,this._canvas.height=e*this._pixelRatio,this.set2DView(t,e),this.setPose(new i.Pose),this._GL.viewport(0,0,this._canvas.width,this._canvas.height)},e.prototype.clear=function(t){t&&this._GL.clearColor(t[0],t[1],t[2],null!=t[3]?t[3]:1),this._GL.clear(this._GL.COLOR_BUFFER_BIT|this._GL.DEPTH_BUFFER_BIT)},e}(a.WebGLPlatform);e.WebGLCanvasPlatform2D=c;var u=function(t){function e(e,n,r){void 0===n&&(n=600),void 0===r&&(r=400);var o=this,i=e.getContext("webgl")||e.getContext("experimental-webgl");return(o=t.call(this,i)||this)._canvas=e,i.clearColor(1,1,1,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.DEPTH_TEST),i.enable(i.BLEND),i.disable(i.CULL_FACE),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),o._pixelRatio=2,t.prototype.set3DView.call(o,Math.PI/4,n/r,.1,1e3),o.resize(n,r),o}return o(e,t),Object.defineProperty(e.prototype,"pixelRatio",{get:function(){return this._pixelRatio},set:function(t){this._pixelRatio=t,this.resize(this._width,this._height)},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,n){this._width=e,this._height=n,this._canvas.style.width=e+"px",this._canvas.style.height=n+"px",this._canvas.width=e*this._pixelRatio,this._canvas.height=n*this._pixelRatio,this._GL.viewport(0,0,this._canvas.width,this._canvas.height),t.prototype.set3DView.call(this,this._viewInfo.fovY,this._width/this._height,this._viewInfo.near,this._viewInfo.far)},e.prototype.set3DView=function(e,n,r){void 0===n&&(n=.1),void 0===r&&(r=1e3),t.prototype.set3DView.call(this,e,this._width/this._height,n,r)},e.prototype.setMVPMatrix=function(t){throw new i.RuntimeError("not implemented")},e.prototype.clear=function(t){t&&this._GL.clearColor(t[0],t[1],t[2],null!=t[3]?t[3]:1),this._GL.clear(this._GL.COLOR_BUFFER_BIT|this._GL.DEPTH_BUFFER_BIT)},e}(a.WebGLPlatform);e.WebGLCanvasPlatform3D=u;var l=function(t){function e(e,n,r){void 0===n&&(n=600),void 0===r&&(r=400);var o=this,i=e.getContext("webgl")||e.getContext("experimental-webgl");return(o=t.call(this,i)||this)._canvas=e,i.clearColor(1,1,1,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.enable(i.DEPTH_TEST),i.enable(i.BLEND),i.disable(i.CULL_FACE),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),o._pixelRatio=s.getDefaultDevicePixelRatio(),o.resize(n,r),o.setWebVRView([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),o}return o(e,t),Object.defineProperty(e.prototype,"pixelRatio",{get:function(){return this._pixelRatio},set:function(t){this._pixelRatio=t,this.resize(this._width,this._height)},enumerable:!0,configurable:!0}),e.prototype.resize=function(t,e){this._width=t,this._height=e,this._canvas.width=t*this._pixelRatio,this._canvas.height=e*this._pixelRatio},e.prototype.set3DView=function(e,n,r){void 0===n&&(n=.1),void 0===r&&(r=1e3),t.prototype.set3DView.call(this,e,this._width/this._height,n,r)},e.prototype.setWebVRView=function(e,n){t.prototype.setWebVRView.call(this,e,n)},e.prototype.clear=function(t){t&&this._GL.clearColor(t[0],t[1],t[2],null!=t[3]?t[3]:1),this._GL.clear(this._GL.COLOR_BUFFER_BIT|this._GL.DEPTH_BUFFER_BIT)},e}(a.WebGLPlatform);e.WebGLCanvasPlatformWebVR=l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(n(1));var r=n(19);e.WebGLPlatform=r.WebGLPlatform,e.WebGLCanvasPlatform2D=r.WebGLCanvasPlatform2D,e.WebGLCanvasPlatform3D=r.WebGLCanvasPlatform3D,e.WebGLCanvasPlatformWebVR=r.WebGLCanvasPlatformWebVR;var o=n(49);!function(t){t.isotype=o.isotype}(e.mark||(e.mark={})),n(19)},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){this._dict={}}return t.prototype.set=function(t,e){this._dict[t]=e},t.prototype.has=function(t){return this._dict.hasOwnProperty(t)},t.prototype.delete=function(t){delete this._dict[t]},t.prototype.get=function(t){return this._dict.hasOwnProperty(t)?this._dict[t]:void 0},t.prototype.forEach=function(t){for(var e in this._dict)this._dict.hasOwnProperty(e)&&t(this._dict[e],e)},t.prototype.clone=function(){var e=new t;return this.forEach(function(t,n){e.set(n,t)}),e},t}();e.Dictionary=r,e.shallowClone=function(t){var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},e.attemptName=function(t,e){if(e(t))return t;for(var n=1;;n++){var r=t+n.toString();if(e(r))return r}}},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(e,n,r,o){void 0===e&&(e=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===o&&(o=1);var i=t.call(this)||this;return i.r=e,i.g=n,i.b=r,i.a=o,i}return o(e,t),e.FromArray=function(t){return new e(t[0],t[1],t[2],t[3])},e.FromHTML=function(t,n){return void 0===n&&(n=1),e.FromArray(a(t,n))},e.prototype.toArray=function(){return[this.r,this.g,this.b,this.a]},e.prototype.clone=function(){return new e(this.r,this.g,this.b,this.a)},e}(n(12).MathType);function a(t,e){var n;return void 0===t&&(t="#000000"),void 0===e&&(e=1),(n=t.match(/^ *rgb *\( *([0-9\.\-e]+) *, *([0-9\.\-e]+) *, *([0-9\.\-e]+) *\) *$/))?[+n[1]/255,+n[2]/255,+n[3]/255,e]:(n=t.match(/^ *rgba *\( *([0-9\.\-e]+) *, *([0-9\.\-e]+) *, *([0-9\.\-e]+) *, *([0-9\.\-e]+) *\) *$/))?[+n[1]/255,+n[2]/255,+n[3]/255,e*+n[4]]:(n=t.match(/^ *\#([0-9a-fA-F]{3}) *$/))?[17*parseInt(n[1][0],16)/255,17*parseInt(n[1][1],16)/255,17*parseInt(n[1][2],16)/255,e]:(n=t.match(/^ *\#([0-9a-fA-F]{6}) *$/))?[parseInt(n[1].slice(0,2),16)/255,parseInt(n[1].slice(2,4),16)/255,parseInt(n[1].slice(4,6),16)/255,e]:[0,0,0,1]}e.Color=i,e.colorFromHTML=a},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(e){var n=t.call(this,e)||this;return n.stack=new Error(e).stack,n}return o(e,t),e}(Error);e.BaseError=i;var a=function(t){function e(e,n,r){var o=t.call(this,e)||this;return o.name="ParseError",o.message=e,o.start=n,o.end=r,o}return o(e,t),e}(i);e.ParseError=a;var s=function(t){function e(e,n,r){var o=t.call(this,e)||this;return o.name="CompileError",o.message=e,o.start=n,o.end=r,o}return o(e,t),e}(i);e.CompileError=s;var c=function(t){function e(e,n,r){var o=t.call(this,e)||this;return o.name="RuntimeError",o.message=e,o.start=n,o.end=r,o}return o(e,t),e}(i);e.RuntimeError=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(3);function o(t,e){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return{type:"function",functionName:r.getInternalName({name:t,argTypes:n.map(function(t){return t.valueType}),returnType:e}),arguments:n,valueType:e}}function i(t,e){for(var n=[],o=2;o<arguments.length;o++)n[o-2]=arguments[o];return{type:"function",functionName:r.getInternalName({name:"@"+t,argTypes:n.map(function(t){return t.valueType}),returnType:e}),valueType:e,arguments:n}}e.func=o,e.op=i,e.cast=function(t,e){return{type:"function",functionName:r.getInternalName({name:"cast:"+t.valueType+":"+e,argTypes:[t.valueType],returnType:e}),valueType:e,arguments:[t]}},e.variable=function(t,e){return{type:"variable",variableName:t,valueType:e}},e.constant=function(t,e){return{type:"constant",value:t,valueType:e}},e.mix=function(t,e,n){return o("mix",t.valueType,t,e,n)},e.exp=function(t){return o("exp","float",t)},e.log=function(t){return o("log","float",t)},e.add=function(t,e){return i("+",t.valueType,t,e)},e.sub=function(t,e){return i("-",t.valueType,t,e)},e.mul=function(t,e){return i("*",t.valueType,t,e)},e.div=function(t,e){return i("/",t.valueType,t,e)},e.equals=function(t,e){return i("==","bool",t,e)},e.greaterThan=function(t,e){return i(">","bool",t,e)},e.lessThan=function(t,e){return i("<","bool",t,e)},e.greaterThanOrEquals=function(t,e){return i(">=","bool",t,e)},e.lessThanOrEquals=function(t,e){return i("<=","bool",t,e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(4),i=new r.Dictionary;function a(t,e){var n=null;i.has(t)?n=i.get(t):(n=new r.Dictionary,i.set(t,n));for(var a=0,s=o.parseFile(e).blocks;a<s.length;a++){var c=s[a];if("function"==c.type){var u=c;n.set(u.name,u)}}}a("P2D",n(28).primitives),a("P3D",n(29).primitives),e.getModule=function(t){return i.get(t)},e.getModuleFunction=function(t,e){return i.get(t).get(e)},e.forEachModuleFunction=function(t,e){return i.get(t).forEach(e)}},function(t,e){t.exports=function(){"use strict";function t(e,n,r,o){this.message=e,this.expected=n,this.found=r,this.location=o,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,t)}return function(t,e){function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n}(t,Error),{SyntaxError:t,parse:function(e){var n,r=arguments.length>1?arguments[1]:{},o={},i={FileEntry:We,ExpressionEntry:function(){var t,e,n;return t=ke,(e=_n())!==o&&(n=en())!==o&&_n()!==o?(e=c(n),t=e):(ke=t,t=o),t}},a=We,s=function(t){return{blocks:t.map(function(t){return t[0]})}},c=function(t){return t},u="function",l={type:"literal",value:"function",description:'"function"'},p="mark",f={type:"literal",value:"mark",description:'"mark"'},h="shader",d={type:"literal",value:"shader",description:'"shader"'},v="(",m={type:"literal",value:"(",description:'"("'},_=")",y={type:"literal",value:")",description:'")"'},g=":",x={type:"literal",value:":",description:'":"'},b="{",V={type:"literal",value:"{",description:'"{"'},w="}",T={type:"literal",value:"}",description:'"}"'},A=function(t,e,n,r,o){return{type:"function",isMark:"mark"==gn(t),isShader:"shader"==gn(t),name:e,returnType:r?r[3]:"void",arguments:n,statements:o}},C="let",E={type:"literal",value:"let",description:'"let"'},P="=",M={type:"literal",value:"=",description:'"="'},S=";",F={type:"literal",value:";",description:'";"'},R=function(t,e,n){return{type:"global",name:t,valueType:e?e[3]:"auto",default:n?n[3]:void 0}},B="import",L={type:"literal",value:"import",description:'"import"'},k="*",I={type:"literal",value:"*",description:'"*"'},O="from",z={type:"literal",value:"from",description:'"from"'},N=function(t){return{type:"import",moduleName:t,functionNames:null}},D=",",U={type:"literal",value:",",description:'","'},j=function(t,e,n){return{type:"import",moduleName:n,functionNames:xn(t,e,3)}},G=function(t,e){return xn(t,e,3)},W=function(){return[]},X=function(t,e,n){return{type:e,name:t,default:n}},q=function(t,e){return{type:e,name:t}},Q=function(t,e){return xn(t,e,1)},Z=function(t){return t},H=function(t){return{type:"statements",statements:t}},Y="return",K={type:"literal",value:"return",description:'"return"'},$=function(t){return{type:"return",value:t}},J="discard",tt={type:"literal",value:"discard",description:'"discard"'},et=function(){return{type:"discard"}},nt="emit",rt={type:"literal",value:"emit",description:'"emit"'},ot="[",it={type:"literal",value:"[",description:'"["'},at="]",st={type:"literal",value:"]",description:'"]"'},ct=function(t){return{type:"emit",vertices:t}},ut=function(t){return{type:"emit",vertices:[t]}},lt=function(t,e){return{name:t,value:e}},pt=function(t,e){return bn(xn(t,e,3)).kwargs},ft=function(){return{}},ht=function(t,e){return xn(t,e,4)},dt=function(t){return{type:"expression",expression:t}},vt=function(t,e,n){return{type:"declare",variableType:e?e[3]:"auto",variableName:t,initial:n?n[3]:void 0}},mt=function(t,e){return{type:"assign",variableName:t,expression:e}},_t="for",yt={type:"literal",value:"for",description:'"for"'},gt="in",xt={type:"literal",value:"in",description:'"in"'},bt="..",Vt={type:"literal",value:"..",description:'".."'},wt=function(t,e,n,r){return{type:"for",variableName:t,statement:r,start:e,end:n}},Tt="if",At={type:"literal",value:"if",description:'"if"'},Ct="else",Et={type:"literal",value:"else",description:'"else"'},Pt=function(t,e,n,r){return{type:"if",conditions:[{condition:t,statement:e}].concat(n.map(function(t){return{condition:t[7],statement:t[11]}})),else:r?r[3]:null}},Mt="&&",St={type:"literal",value:"&&",description:'"&&"'},Ft="||",Rt={type:"literal",value:"||",description:'"||"'},Bt=">=",Lt={type:"literal",value:">=",description:'">="'},kt=">",It={type:"literal",value:">",description:'">"'},Ot="<=",zt={type:"literal",value:"<=",description:'"<="'},Nt="<",Dt={type:"literal",value:"<",description:'"<"'},Ut="==",jt={type:"literal",value:"==",description:'"=="'},Gt="!=",Wt={type:"literal",value:"!=",description:'"!="'},Xt="+",qt={type:"literal",value:"+",description:'"+"'},Qt="-",Zt={type:"literal",value:"-",description:'"-"'},Ht="/",Yt={type:"literal",value:"/",description:'"/"'},Kt="%",$t={type:"literal",value:"%",description:'"%"'},Jt="not",te={type:"literal",value:"not",description:'"not"'},ee=function(t){return Vn({type:"operator",operator:"!",args:[item]})},ne=function(t,e){return function(t,e){var n=t;return e.forEach(function(t){var e=t[1],r=t[3];n=Vn({type:"operator",operator:e,args:[n,r]})}),n}(t,e)},re=function(t){return Vn({type:"operator",operator:"-",args:[t]})},oe=function(t){return{type:"variable",name:t}},ie=".",ae={type:"literal",value:".",description:'"."'},se=function(t,e){return{type:"field",value:t,fieldName:e}},ce=function(t,e){return{type:"function",name:t,args:bn(e)}},ue=function(t){return{value:t}},le=function(t){return{type:"value",valueType:"float",value:t}},pe=function(t){return{type:"value",valueType:"bool",value:t}},fe=function(t){return{type:"value",valueType:"int",value:t}},he=function(t,e){var n=xn(t,e,3);return{type:"value",valueType:"Vector"+n.length,value:n}},de=/^[+\-]/,ve={type:"class",value:"[+-]",description:"[+-]"},me=/^[0-9]/,_e={type:"class",value:"[0-9]",description:"[0-9]"},ye=function(t){return parseFloat(gn(t))},ge=/^[eE]/,xe={type:"class",value:"[eE]",description:"[eE]"},be="true",Ve={type:"literal",value:"true",description:'"true"'},we=function(){return!0},Te="false",Ae={type:"literal",value:"false",description:'"false"'},Ce=function(){return!1},Ee=/^[a-zA-Z_]/,Pe={type:"class",value:"[a-zA-Z_]",description:"[a-zA-Z_]"},Me=/^[a-zA-Z0-9_]/,Se={type:"class",value:"[a-zA-Z0-9_]",description:"[a-zA-Z0-9_]"},Fe=function(t){return gn(t)},Re=/^[ \t\n]/,Be={type:"class",value:"[ \\t\\n]",description:"[ \\t\\n]"},Le=function(){return" "},ke=0,Ie=[{line:1,column:1,seenCR:!1}],Oe=0,ze=[],Ne=0;if("startRule"in r){if(!(r.startRule in i))throw new Error("Can't start parsing from rule \""+r.startRule+'".');a=i[r.startRule]}function De(t){var n,r,o=Ie[t];if(o)return o;for(n=t-1;!Ie[n];)n--;for(o={line:(o=Ie[n]).line,column:o.column,seenCR:o.seenCR};n<t;)"\n"===(r=e.charAt(n))?(o.seenCR||o.line++,o.column=1,o.seenCR=!1):"\r"===r||"\u2028"===r||"\u2029"===r?(o.line++,o.column=1,o.seenCR=!0):(o.column++,o.seenCR=!1),n++;return Ie[t]=o,o}function Ue(t,e){var n=De(t),r=De(e);return{start:{offset:t,line:n.line,column:n.column},end:{offset:e,line:r.line,column:r.column}}}function je(t){ke<Oe||(ke>Oe&&(Oe=ke,ze=[]),ze.push(t))}function Ge(e,n,r,o){return null!==n&&function(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}(n),new t(null!==e?e:function(t,e){var n,r=new Array(t.length);for(n=0;n<t.length;n++)r[n]=t[n].description;return"Expected "+(t.length>1?r.slice(0,-1).join(", ")+" or "+r[t.length-1]:r[0])+" but "+(e?'"'+function(t){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+e(t)}).replace(/[\u0100-\u0FFF]/g,function(t){return"\\u0"+e(t)}).replace(/[\u1000-\uFFFF]/g,function(t){return"\\u"+e(t)})}(e)+'"':"end of input")+" found."}(n,r),n,r,o)}function We(){var t,e,n,r,i;if(t=ke,_n()!==o){for(e=[],n=ke,(r=Xe())!==o&&(i=_n())!==o?n=r=[r,i]:(ke=n,n=o);n!==o;)e.push(n),n=ke,(r=Xe())!==o&&(i=_n())!==o?n=r=[r,i]:(ke=n,n=o);e!==o?t=s(e):(ke=t,t=o)}else ke=t,t=o;return t}function Xe(){var t;return(t=function(){var t,n,r,i,a,s,c,C,E,P,M,S;return t=ke,e.substr(ke,8)===u?(n=u,ke+=8):(n=o,0===Ne&&je(l)),n===o&&(e.substr(ke,4)===p?(n=p,ke+=4):(n=o,0===Ne&&je(f)),n===o&&(e.substr(ke,6)===h?(n=h,ke+=6):(n=o,0===Ne&&je(d)))),n!==o&&yn()!==o&&(r=mn())!==o&&_n()!==o?(40===e.charCodeAt(ke)?(i=v,ke++):(i=o,0===Ne&&je(m)),i!==o&&(a=function(){var t,n,r,i,a,s,c,u,l;if(t=ke,(n=_n())!==o)if((r=qe())!==o){for(i=[],a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=qe())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);a!==o;)i.push(a),a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=qe())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);i!==o&&(a=_n())!==o?(n=G(r,i),t=n):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;return t===o&&(t=ke,(n=_n())!==o&&(n=W()),t=n),t}())!==o?(41===e.charCodeAt(ke)?(s=_,ke++):(s=o,0===Ne&&je(y)),s!==o?(c=ke,(C=_n())!==o?(58===e.charCodeAt(ke)?(E=g,ke++):(E=o,0===Ne&&je(x)),E!==o&&(P=_n())!==o&&(M=mn())!==o?c=C=[C,E,P,M]:(ke=c,c=o)):(ke=c,c=o),c===o&&(c=null),c!==o&&(C=_n())!==o?(123===e.charCodeAt(ke)?(E=b,ke++):(E=o,0===Ne&&je(V)),E!==o&&(P=_n())!==o&&(M=Qe())!==o&&_n()!==o?(125===e.charCodeAt(ke)?(S=w,ke++):(S=o,0===Ne&&je(T)),S!==o?(n=A(n,r,a,c,M),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t}())===o&&(t=function(){var t,n,r,i,a,s,c,u,l;return t=ke,e.substr(ke,3)===C?(n=C,ke+=3):(n=o,0===Ne&&je(E)),n!==o&&yn()!==o&&(r=mn())!==o?(i=ke,(a=_n())!==o?(58===e.charCodeAt(ke)?(s=g,ke++):(s=o,0===Ne&&je(x)),s!==o&&(c=_n())!==o&&(u=mn())!==o?i=a=[a,s,c,u]:(ke=i,i=o)):(ke=i,i=o),i===o&&(i=null),i!==o?(a=ke,(s=_n())!==o?(61===e.charCodeAt(ke)?(c=P,ke++):(c=o,0===Ne&&je(M)),c!==o&&(u=_n())!==o&&(l=fn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o),a===o&&(a=null),a!==o&&(s=_n())!==o?(59===e.charCodeAt(ke)?(c=S,ke++):(c=o,0===Ne&&je(F)),c!==o?(n=R(r,i,a),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t}())===o&&(t=function(){var t,n,r,i,a,s,c,u,l,p,f,h;if(t=ke,e.substr(ke,6)===B?(n=B,ke+=6):(n=o,0===Ne&&je(L)),n!==o&&yn()!==o?(42===e.charCodeAt(ke)?(r=k,ke++):(r=o,0===Ne&&je(I)),r!==o&&yn()!==o?(e.substr(ke,4)===O?(i=O,ke+=4):(i=o,0===Ne&&je(z)),i!==o&&(a=yn())!==o&&(s=mn())!==o&&(c=_n())!==o?(59===e.charCodeAt(ke)?(u=S,ke++):(u=o,0===Ne&&je(F)),u!==o?(n=N(s),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t===o)if(t=ke,e.substr(ke,6)===B?(n=B,ke+=6):(n=o,0===Ne&&je(L)),n!==o)if(_n()!==o)if(123===e.charCodeAt(ke)?(r=b,ke++):(r=o,0===Ne&&je(V)),r!==o)if(_n()!==o)if((i=mn())!==o){for(a=[],s=ke,(c=_n())!==o?(44===e.charCodeAt(ke)?(u=D,ke++):(u=o,0===Ne&&je(U)),u!==o&&(l=_n())!==o&&(p=mn())!==o?s=c=[c,u,l,p]:(ke=s,s=o)):(ke=s,s=o);s!==o;)a.push(s),s=ke,(c=_n())!==o?(44===e.charCodeAt(ke)?(u=D,ke++):(u=o,0===Ne&&je(U)),u!==o&&(l=_n())!==o&&(p=mn())!==o?s=c=[c,u,l,p]:(ke=s,s=o)):(ke=s,s=o);a!==o&&(s=_n())!==o?(125===e.charCodeAt(ke)?(c=w,ke++):(c=o,0===Ne&&je(T)),c!==o&&(u=_n())!==o?(e.substr(ke,4)===O?(l=O,ke+=4):(l=o,0===Ne&&je(z)),l!==o&&(p=yn())!==o&&(f=mn())!==o&&_n()!==o?(59===e.charCodeAt(ke)?(h=S,ke++):(h=o,0===Ne&&je(F)),h!==o?(n=j(i,a,f),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;return t}()),t}function qe(){var t,n,r,i,a,s;return t=ke,(n=mn())!==o&&_n()!==o?(58===e.charCodeAt(ke)?(r=g,ke++):(r=o,0===Ne&&je(x)),r!==o&&_n()!==o&&(i=mn())!==o&&_n()!==o?(61===e.charCodeAt(ke)?(a=P,ke++):(a=o,0===Ne&&je(M)),a!==o&&_n()!==o&&(s=fn())!==o?t=n=X(n,i,s):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t===o&&(t=ke,(n=mn())!==o&&_n()!==o?(58===e.charCodeAt(ke)?(r=g,ke++):(r=o,0===Ne&&je(x)),r!==o&&_n()!==o&&(i=mn())!==o?t=n=q(n,i):(ke=t,t=o)):(ke=t,t=o)),t}function Qe(){var t,e,n,r,i,a;if(t=ke,(e=Ze())!==o){for(n=[],r=ke,(i=_n())!==o&&(a=Ze())!==o?r=i=[i,a]:(ke=r,r=o);r!==o;)n.push(r),r=ke,(i=_n())!==o&&(a=Ze())!==o?r=i=[i,a]:(ke=r,r=o);n!==o?t=e=Q(e,n):(ke=t,t=o)}else ke=t,t=o;return t===o&&(t=ke,(e=_n())!==o&&(e=W()),t=e),t}function Ze(){var t,n,r,i;return t=ke,(n=function(){var t,n,r;return t=ke,e.substr(ke,6)===Y?(n=Y,ke+=6):(n=o,0===Ne&&je(K)),n!==o&&yn()!==o&&(r=en())!==o?(n=$(r),t=n):(ke=t,t=o),t}())===o&&(n=function(){var t,n,r,i,a;return t=ke,e.substr(ke,4)===nt?(n=nt,ke+=4):(n=o,0===Ne&&je(rt)),n!==o&&_n()!==o?(91===e.charCodeAt(ke)?(r=ot,ke++):(r=o,0===Ne&&je(it)),r!==o&&(i=function(){var t,n,r,i,a,s,c,u,l,p,f,h,d;if(t=ke,(n=_n())!==o)if(123===e.charCodeAt(ke)?(r=b,ke++):(r=o,0===Ne&&je(V)),r!==o)if((i=Ye())!==o)if(125===e.charCodeAt(ke)?(a=w,ke++):(a=o,0===Ne&&je(T)),a!==o){for(s=[],c=ke,(u=_n())!==o?(44===e.charCodeAt(ke)?(l=D,ke++):(l=o,0===Ne&&je(U)),l!==o&&(p=_n())!==o?(123===e.charCodeAt(ke)?(f=b,ke++):(f=o,0===Ne&&je(V)),f!==o&&(h=Ye())!==o?(125===e.charCodeAt(ke)?(d=w,ke++):(d=o,0===Ne&&je(T)),d!==o?c=u=[u,l,p,f,h,d]:(ke=c,c=o)):(ke=c,c=o)):(ke=c,c=o)):(ke=c,c=o);c!==o;)s.push(c),c=ke,(u=_n())!==o?(44===e.charCodeAt(ke)?(l=D,ke++):(l=o,0===Ne&&je(U)),l!==o&&(p=_n())!==o?(123===e.charCodeAt(ke)?(f=b,ke++):(f=o,0===Ne&&je(V)),f!==o&&(h=Ye())!==o?(125===e.charCodeAt(ke)?(d=w,ke++):(d=o,0===Ne&&je(T)),d!==o?c=u=[u,l,p,f,h,d]:(ke=c,c=o)):(ke=c,c=o)):(ke=c,c=o)):(ke=c,c=o);s!==o&&(c=_n())!==o?(n=ht(i,s),t=n):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;return t===o&&(t=ke,(n=_n())!==o&&(n=W()),t=n),t}())!==o?(93===e.charCodeAt(ke)?(a=at,ke++):(a=o,0===Ne&&je(st)),a!==o?(n=ct(i),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t===o&&(t=ke,e.substr(ke,4)===nt?(n=nt,ke+=4):(n=o,0===Ne&&je(rt)),n!==o&&_n()!==o?(123===e.charCodeAt(ke)?(r=b,ke++):(r=o,0===Ne&&je(V)),r!==o&&(i=Ye())!==o?(125===e.charCodeAt(ke)?(a=w,ke++):(a=o,0===Ne&&je(T)),a!==o?(n=ut(i),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)),t}())===o&&(n=function(){var t;return ke,e.substr(ke,7)===J?(t=J,ke+=7):(t=o,0===Ne&&je(tt)),t!==o&&(t=et()),t}())===o&&(n=function(){var t,n,r,i,a,s,c,u,l;return t=ke,e.substr(ke,3)===C?(n=C,ke+=3):(n=o,0===Ne&&je(E)),n!==o&&yn()!==o&&(r=mn())!==o?(i=ke,(a=_n())!==o?(58===e.charCodeAt(ke)?(s=g,ke++):(s=o,0===Ne&&je(x)),s!==o&&(c=_n())!==o&&(u=mn())!==o?i=a=[a,s,c,u]:(ke=i,i=o)):(ke=i,i=o),i===o&&(i=null),i!==o?(a=ke,(s=_n())!==o?(61===e.charCodeAt(ke)?(c=P,ke++):(c=o,0===Ne&&je(M)),c!==o&&(u=_n())!==o&&(l=en())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o),a===o&&(a=null),a!==o?(n=vt(r,i,a),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t}())===o&&(n=function(){var t,n,r,i;return t=ke,(n=mn())!==o&&_n()!==o?(61===e.charCodeAt(ke)?(r=P,ke++):(r=o,0===Ne&&je(M)),r!==o&&_n()!==o&&(i=en())!==o?(n=mt(n,i),t=n):(ke=t,t=o)):(ke=t,t=o),t}())===o&&(n=function(){var t;return ke,(t=en())!==o&&(t=dt(t)),t}()),n!==o&&_n()!==o?(59===e.charCodeAt(ke)?(r=S,ke++):(r=o,0===Ne&&je(F)),r!==o?t=n=Z(n):(ke=t,t=o)):(ke=t,t=o),t===o&&(t=function(){var t,n,r,i,a,s,c,u,l,p;return t=ke,e.substr(ke,3)===_t?(n=_t,ke+=3):(n=o,0===Ne&&je(yt)),n!==o&&_n()!==o?(40===e.charCodeAt(ke)?(r=v,ke++):(r=o,0===Ne&&je(m)),r!==o&&_n()!==o&&(i=mn())!==o&&_n()!==o?(e.substr(ke,2)===gt?(a=gt,ke+=2):(a=o,0===Ne&&je(xt)),a!==o&&_n()!==o&&(s=hn())!==o&&_n()!==o?(e.substr(ke,2)===bt?(c=bt,ke+=2):(c=o,0===Ne&&je(Vt)),c!==o&&_n()!==o&&(u=hn())!==o&&_n()!==o?(41===e.charCodeAt(ke)?(l=_,ke++):(l=o,0===Ne&&je(y)),l!==o&&_n()!==o&&(p=Ze())!==o?(n=wt(i,s,u,p),t=n):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t}())===o&&(t=function(){var t,n,r,i,a,s,c,u,l,p,f,h,d,g,x,b,V,w,T,A;if(t=ke,e.substr(ke,2)===Tt?(n=Tt,ke+=2):(n=o,0===Ne&&je(At)),n!==o)if(_n()!==o)if(40===e.charCodeAt(ke)?(r=v,ke++):(r=o,0===Ne&&je(m)),r!==o)if(_n()!==o)if((i=en())!==o)if(_n()!==o)if(41===e.charCodeAt(ke)?(a=_,ke++):(a=o,0===Ne&&je(y)),a!==o)if(_n()!==o)if((s=Ze())!==o){for(c=[],u=ke,(l=_n())!==o?(e.substr(ke,4)===Ct?(p=Ct,ke+=4):(p=o,0===Ne&&je(Et)),p!==o&&(f=yn())!==o?(e.substr(ke,2)===Tt?(h=Tt,ke+=2):(h=o,0===Ne&&je(At)),h!==o&&(d=_n())!==o?(40===e.charCodeAt(ke)?(g=v,ke++):(g=o,0===Ne&&je(m)),g!==o&&(x=_n())!==o&&(b=en())!==o&&(V=_n())!==o?(41===e.charCodeAt(ke)?(w=_,ke++):(w=o,0===Ne&&je(y)),w!==o&&(T=_n())!==o&&(A=Ze())!==o?u=l=[l,p,f,h,d,g,x,b,V,w,T,A]:(ke=u,u=o)):(ke=u,u=o)):(ke=u,u=o)):(ke=u,u=o)):(ke=u,u=o);u!==o;)c.push(u),u=ke,(l=_n())!==o?(e.substr(ke,4)===Ct?(p=Ct,ke+=4):(p=o,0===Ne&&je(Et)),p!==o&&(f=yn())!==o?(e.substr(ke,2)===Tt?(h=Tt,ke+=2):(h=o,0===Ne&&je(At)),h!==o&&(d=_n())!==o?(40===e.charCodeAt(ke)?(g=v,ke++):(g=o,0===Ne&&je(m)),g!==o&&(x=_n())!==o&&(b=en())!==o&&(V=_n())!==o?(41===e.charCodeAt(ke)?(w=_,ke++):(w=o,0===Ne&&je(y)),w!==o&&(T=_n())!==o&&(A=Ze())!==o?u=l=[l,p,f,h,d,g,x,b,V,w,T,A]:(ke=u,u=o)):(ke=u,u=o)):(ke=u,u=o)):(ke=u,u=o)):(ke=u,u=o);c!==o?(u=ke,(l=_n())!==o?(e.substr(ke,4)===Ct?(p=Ct,ke+=4):(p=o,0===Ne&&je(Et)),p!==o&&(f=_n())!==o&&(h=Ze())!==o?u=l=[l,p,f,h]:(ke=u,u=o)):(ke=u,u=o),u===o&&(u=null),u!==o?(n=Pt(i,s,c,u),t=n):(ke=t,t=o)):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;return t}())===o&&(t=ke,123===e.charCodeAt(ke)?(n=b,ke++):(n=o,0===Ne&&je(V)),n!==o&&_n()!==o&&(r=Qe())!==o&&_n()!==o?(125===e.charCodeAt(ke)?(i=w,ke++):(i=o,0===Ne&&je(T)),i!==o?t=n=H(r):(ke=t,t=o)):(ke=t,t=o)),t}function He(){var t,n,r,i;return t=ke,(n=mn())!==o&&_n()!==o?(58===e.charCodeAt(ke)?(r=g,ke++):(r=o,0===Ne&&je(x)),r!==o&&_n()!==o&&(i=en())!==o?t=n=lt(n,i):(ke=t,t=o)):(ke=t,t=o),t}function Ye(){var t,n,r,i,a,s,c,u,l;if(t=ke,(n=_n())!==o)if((r=He())!==o){for(i=[],a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=He())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);a!==o;)i.push(a),a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=He())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);i!==o&&(a=_n())!==o?t=n=pt(r,i):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;return t===o&&(t=ke,(n=_n())!==o&&(n=ft()),t=n),t}function Ke(){var t;return e.substr(ke,2)===Mt?(t=Mt,ke+=2):(t=o,0===Ne&&je(St)),t===o&&(e.substr(ke,2)===Ft?(t=Ft,ke+=2):(t=o,0===Ne&&je(Rt))),t}function $e(){var t;return e.substr(ke,2)===Bt?(t=Bt,ke+=2):(t=o,0===Ne&&je(Lt)),t===o&&(62===e.charCodeAt(ke)?(t=kt,ke++):(t=o,0===Ne&&je(It)),t===o&&(e.substr(ke,2)===Ot?(t=Ot,ke+=2):(t=o,0===Ne&&je(zt)),t===o&&(60===e.charCodeAt(ke)?(t=Nt,ke++):(t=o,0===Ne&&je(Dt)),t===o&&(e.substr(ke,2)===Ut?(t=Ut,ke+=2):(t=o,0===Ne&&je(jt)),t===o&&(e.substr(ke,2)===Gt?(t=Gt,ke+=2):(t=o,0===Ne&&je(Wt))))))),t}function Je(){var t;return 43===e.charCodeAt(ke)?(t=Xt,ke++):(t=o,0===Ne&&je(qt)),t===o&&(45===e.charCodeAt(ke)?(t=Qt,ke++):(t=o,0===Ne&&je(Zt))),t}function tn(){var t;return 42===e.charCodeAt(ke)?(t=k,ke++):(t=o,0===Ne&&je(I)),t===o&&(47===e.charCodeAt(ke)?(t=Ht,ke++):(t=o,0===Ne&&je(Yt)),t===o&&(37===e.charCodeAt(ke)?(t=Kt,ke++):(t=o,0===Ne&&je($t)))),t}function en(){var t,n,r,i,a,s,c,u;if(t=ke,e.substr(ke,3)===Jt?(n=Jt,ke+=3):(n=o,0===Ne&&je(te)),n!==o&&(r=_n())!==o&&(i=en())!==o?t=n=ee(i):(ke=t,t=o),t===o)if(t=ke,(n=nn())!==o){for(r=[],i=ke,(a=_n())!==o&&(s=Ke())!==o&&(c=_n())!==o&&(u=nn())!==o?i=a=[a,s,c,u]:(ke=i,i=o);i!==o;)r.push(i),i=ke,(a=_n())!==o&&(s=Ke())!==o&&(c=_n())!==o&&(u=nn())!==o?i=a=[a,s,c,u]:(ke=i,i=o);r!==o?t=n=ne(n,r):(ke=t,t=o)}else ke=t,t=o;return t}function nn(){var t,e,n,r,i,a,s,c;if(t=ke,(e=rn())!==o){for(n=[],r=ke,(i=_n())!==o&&(a=$e())!==o&&(s=_n())!==o&&(c=rn())!==o?r=i=[i,a,s,c]:(ke=r,r=o);r!==o;)n.push(r),r=ke,(i=_n())!==o&&(a=$e())!==o&&(s=_n())!==o&&(c=rn())!==o?r=i=[i,a,s,c]:(ke=r,r=o);n!==o?t=e=ne(e,n):(ke=t,t=o)}else ke=t,t=o;return t===o&&(t=rn()),t}function rn(){var t,e,n,r,i,a,s,c;if(t=ke,(e=on())!==o){for(n=[],r=ke,(i=_n())!==o&&(a=Je())!==o&&(s=_n())!==o&&(c=on())!==o?r=i=[i,a,s,c]:(ke=r,r=o);r!==o;)n.push(r),r=ke,(i=_n())!==o&&(a=Je())!==o&&(s=_n())!==o&&(c=on())!==o?r=i=[i,a,s,c]:(ke=r,r=o);n!==o?t=e=ne(e,n):(ke=t,t=o)}else ke=t,t=o;return t===o&&(t=on()),t}function on(){var t,e,n,r,i,a,s,c;if(t=ke,(e=an())!==o){for(n=[],r=ke,(i=_n())!==o&&(a=tn())!==o&&(s=_n())!==o&&(c=an())!==o?r=i=[i,a,s,c]:(ke=r,r=o);r!==o;)n.push(r),r=ke,(i=_n())!==o&&(a=tn())!==o&&(s=_n())!==o&&(c=an())!==o?r=i=[i,a,s,c]:(ke=r,r=o);n!==o?t=e=ne(e,n):(ke=t,t=o)}else ke=t,t=o;return t===o&&(t=an()),t}function an(){var t,n,r;return t=ke,45===e.charCodeAt(ke)?(n=Qt,ke++):(n=o,0===Ne&&je(Zt)),n!==o&&_n()!==o&&(r=cn())!==o?t=n=re(r):(ke=t,t=o),t===o&&(t=cn()),t}function sn(){var t,n,r,i;return t=ke,40===e.charCodeAt(ke)?(n=v,ke++):(n=o,0===Ne&&je(m)),n!==o&&_n()!==o&&(r=en())!==o&&_n()!==o?(41===e.charCodeAt(ke)?(i=_,ke++):(i=o,0===Ne&&je(y)),i!==o?t=n=c(r):(ke=t,t=o)):(ke=t,t=o),t}function cn(){var t;return(t=ln())===o&&(t=function(){var t,n,r,i;return t=ke,(n=ln())===o&&(n=un())===o&&(n=sn()),n!==o?(46===e.charCodeAt(ke)?(r=ie,ke++):(r=o,0===Ne&&je(ae)),r!==o&&(i=mn())!==o?(n=se(n,i),t=n):(ke=t,t=o)):(ke=t,t=o),t}())===o&&(t=un())===o&&(t=function(){var t,n,r,i,a,s,c,u,l;if(t=ke,(n=dn())!==o&&(n=le(n)),(t=n)===o&&(t=ke,(n=hn())!==o&&(n=pe(n)),(t=n)===o&&(t=ke,(n=vn())!==o&&(n=fe(n)),(t=n)===o)))if(t=ke,91===e.charCodeAt(ke)?(n=ot,ke++):(n=o,0===Ne&&je(it)),n!==o)if(_n()!==o)if((r=dn())!==o){for(i=[],a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=dn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);a!==o;)i.push(a),a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=dn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);i!==o&&(a=_n())!==o?(93===e.charCodeAt(ke)?(s=at,ke++):(s=o,0===Ne&&je(st)),s!==o?(n=he(r,i),t=n):(ke=t,t=o)):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;return t}())===o&&(t=sn()),t}function un(){var t;return ke,(t=mn())!==o&&(t=oe(t)),t}function ln(){var t,n,r,i,a;return t=ke,(n=mn())!==o&&_n()!==o?(40===e.charCodeAt(ke)?(r=v,ke++):(r=o,0===Ne&&je(m)),r!==o&&(i=function(){var t,n,r,i,a,s,c,u,l;if(t=ke,(n=_n())!==o)if((r=pn())!==o){for(i=[],a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=pn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);a!==o;)i.push(a),a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=pn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);i!==o&&(a=_n())!==o?(n=G(r,i),t=n):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;return t===o&&(t=ke,(n=_n())!==o&&(n=W()),t=n),t}())!==o?(41===e.charCodeAt(ke)?(a=_,ke++):(a=o,0===Ne&&je(y)),a!==o?t=n=ce(n,i):(ke=t,t=o)):(ke=t,t=o)):(ke=t,t=o),t}function pn(){var t,n,r,i;return t=ke,(n=mn())!==o&&_n()!==o?(61===e.charCodeAt(ke)?(r=P,ke++):(r=o,0===Ne&&je(M)),r!==o&&_n()!==o&&(i=en())!==o?t=n=lt(n,i):(ke=t,t=o)):(ke=t,t=o),t===o&&(t=ke,(n=en())!==o&&(n=ue(n)),t=n),t}function fn(){var t,n,r,i,a,s,c,u,l;if((t=dn())===o&&(t=hn())===o&&(t=vn())===o)if(t=ke,91===e.charCodeAt(ke)?(n=ot,ke++):(n=o,0===Ne&&je(it)),n!==o)if(_n()!==o)if((r=dn())!==o){for(i=[],a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=dn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);a!==o;)i.push(a),a=ke,(s=_n())!==o?(44===e.charCodeAt(ke)?(c=D,ke++):(c=o,0===Ne&&je(U)),c!==o&&(u=_n())!==o&&(l=dn())!==o?a=s=[s,c,u,l]:(ke=a,a=o)):(ke=a,a=o);i!==o&&(a=_n())!==o?(93===e.charCodeAt(ke)?(s=at,ke++):(s=o,0===Ne&&je(st)),s!==o?t=n=G(r,i):(ke=t,t=o)):(ke=t,t=o)}else ke=t,t=o;else ke=t,t=o;else ke=t,t=o;return t}function hn(){var t,n,r,i;if(ke,t=ke,de.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(ve)),n===o&&(n=null),n!==o){if(r=[],me.test(e.charAt(ke))?(i=e.charAt(ke),ke++):(i=o,0===Ne&&je(_e)),i!==o)for(;i!==o;)r.push(i),me.test(e.charAt(ke))?(i=e.charAt(ke),ke++):(i=o,0===Ne&&je(_e));else r=o;r!==o?t=n=[n,r]:(ke=t,t=o)}else ke=t,t=o;return t!==o&&(t=ye(t)),t}function dn(){var t,n,r,i,a,s,c,u,l;if(ke,t=ke,de.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(ve)),n===o&&(n=null),n!==o){if(r=[],me.test(e.charAt(ke))?(i=e.charAt(ke),ke++):(i=o,0===Ne&&je(_e)),i!==o)for(;i!==o;)r.push(i),me.test(e.charAt(ke))?(i=e.charAt(ke),ke++):(i=o,0===Ne&&je(_e));else r=o;if(r!==o){if(i=ke,46===e.charCodeAt(ke)?(a=ie,ke++):(a=o,0===Ne&&je(ae)),a!==o){if(s=[],me.test(e.charAt(ke))?(c=e.charAt(ke),ke++):(c=o,0===Ne&&je(_e)),c!==o)for(;c!==o;)s.push(c),me.test(e.charAt(ke))?(c=e.charAt(ke),ke++):(c=o,0===Ne&&je(_e));else s=o;s!==o?i=a=[a,s]:(ke=i,i=o)}else ke=i,i=o;if(i===o&&(i=null),i!==o){if(a=ke,ge.test(e.charAt(ke))?(s=e.charAt(ke),ke++):(s=o,0===Ne&&je(xe)),s!==o)if(de.test(e.charAt(ke))?(c=e.charAt(ke),ke++):(c=o,0===Ne&&je(ve)),c===o&&(c=null),c!==o){if(u=[],me.test(e.charAt(ke))?(l=e.charAt(ke),ke++):(l=o,0===Ne&&je(_e)),l!==o)for(;l!==o;)u.push(l),me.test(e.charAt(ke))?(l=e.charAt(ke),ke++):(l=o,0===Ne&&je(_e));else u=o;u!==o?a=s=[s,c,u]:(ke=a,a=o)}else ke=a,a=o;else ke=a,a=o;a===o&&(a=null),a!==o?t=n=[n,r,i,a]:(ke=t,t=o)}else ke=t,t=o}else ke=t,t=o}else ke=t,t=o;return t!==o&&(t=ye(t)),t}function vn(){var t,n;return t=ke,e.substr(ke,4)===be?(n=be,ke+=4):(n=o,0===Ne&&je(Ve)),n!==o&&(n=we()),(t=n)===o&&(t=ke,e.substr(ke,5)===Te?(n=Te,ke+=5):(n=o,0===Ne&&je(Ae)),n!==o&&(n=Ce()),t=n),t}function mn(){var t,n,r,i;if(ke,t=ke,Ee.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(Pe)),n!==o){for(r=[],Me.test(e.charAt(ke))?(i=e.charAt(ke),ke++):(i=o,0===Ne&&je(Se));i!==o;)r.push(i),Me.test(e.charAt(ke))?(i=e.charAt(ke),ke++):(i=o,0===Ne&&je(Se));r!==o?t=n=[n,r]:(ke=t,t=o)}else ke=t,t=o;return t!==o&&(t=Fe(t)),t}function _n(){var t,n;for(ke,t=[],Re.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(Be));n!==o;)t.push(n),Re.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(Be));return t!==o&&(t=Le()),t}function yn(){var t,n;if(ke,t=[],Re.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(Be)),n!==o)for(;n!==o;)t.push(n),Re.test(e.charAt(ke))?(n=e.charAt(ke),ke++):(n=o,0===Ne&&je(Be));else t=o;return t!==o&&(t=Le()),t}function gn(t){if(t instanceof Array){for(var e="",n=0;n<t.length;n++)e+=gn(t[n]);return e}return t||""}function xn(t,e,n){return e?[t].concat(e.map(function(t){return t[n]})):[t]}function bn(t){var e={args:[],kwargs:{}};return t.forEach(function(t){void 0!==t.name?e.kwargs[t.name]=t.value:e.args.push(t.value)}),e}function Vn(t){return{type:"function",name:"@"+t.operator,args:{args:t.args,kwargs:{}}}}if((n=a())!==o&&ke===e.length)return n;throw n!==o&&ke<e.length&&je({type:"end",description:"end of input"}),Ge(null,ze,Oe<e.length?e.charAt(Oe):null,Oe<e.length?Ue(Oe,Oe+1):Ue(Oe,Oe))}}}()},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.primitives="\n    mark Triangle(\n        p1: Vector2,\n        p2: Vector2,\n        p3: Vector2,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        emit [\n            { position: p1, color: color },\n            { position: p2, color: color },\n            { position: p3, color: color }\n        ];\n    }\n\n    mark Rectangle(\n        p1: Vector2,\n        p2: Vector2,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        emit [\n            { position: Vector2(p1.x, p1.y), color: color },\n            { position: Vector2(p2.x, p1.y), color: color },\n            { position: Vector2(p2.x, p2.y), color: color }\n        ];\n        emit [\n            { position: Vector2(p1.x, p1.y), color: color },\n            { position: Vector2(p1.x, p2.y), color: color },\n            { position: Vector2(p2.x, p2.y), color: color }\n        ];\n    }\n\n    mark OutlinedRectangle(\n        p1: Vector2,\n        p2: Vector2,\n        width: float = 1,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        Rectangle(p1, Vector2(p1.x + width, p2.y - width), color);\n        Rectangle(Vector2(p1.x, p2.y - width), Vector2(p2.x - width, p2.y), color);\n        Rectangle(Vector2(p1.x + width, p1.y), Vector2(p2.x, p1.y + width), color);\n        Rectangle(Vector2(p2.x - width, p1.y + width), p2, color);\n    }\n\n    mark Hexagon(\n        center: Vector2,\n        radius: float,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        for(i in 0..5) {\n            let a1 = i / 6.0 * PI * 2.0;\n            let a2 = (i + 1) / 6.0 * PI * 2.0;\n            let p1 = Vector2(radius * cos(a1), radius * sin(a1));\n            let p2 = Vector2(radius * cos(a2), radius * sin(a2));\n            emit [\n                { position: center + p1, color: color },\n                { position: center, color: color },\n                { position: center + p2, color: color }\n            ];\n        }\n    }\n\n    mark Circle16(\n        center: Vector2,\n        radius: float,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        for(i in 0..15) {\n            let a1 = i / 16.0 * PI * 2.0;\n            let a2 = (i + 1) / 16.0 * PI * 2.0;\n            let p1 = Vector2(radius * cos(a1), radius * sin(a1));\n            let p2 = Vector2(radius * cos(a2), radius * sin(a2));\n            emit [\n                { position: center + p1, color: color },\n                { position: center, color: color },\n                { position: center + p2, color: color }\n            ];\n        }\n    }\n\n    mark Circle(\n        center: Vector2,\n        radius: float,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        for(i in 0..31) {\n            let a1 = i / 32.0 * PI * 2.0;\n            let a2 = (i + 1) / 32.0 * PI * 2.0;\n            let p1 = Vector2(radius * cos(a1), radius * sin(a1));\n            let p2 = Vector2(radius * cos(a2), radius * sin(a2));\n            emit [\n                { position: center + p1, color: color },\n                { position: center, color: color },\n                { position: center + p2, color: color }\n            ];\n        }\n    }\n\n    mark Line(\n        p1: Vector2,\n        p2: Vector2,\n        width: float = 1,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        let d = normalize(p2 - p1);\n        let t = Vector2(d.y, -d.x) * (width / 2);\n        emit [\n            { position: p1 + t, color: color },\n            { position: p1 - t, color: color },\n            { position: p2 + t, color: color }\n        ];\n        emit [\n            { position: p1 - t, color: color },\n            { position: p2 - t, color: color },\n            { position: p2 + t, color: color }\n        ];\n    }\n\n    mark Sector2(\n        c: Vector2,\n        p1: Vector2,\n        p2: Vector2,\n        color: Color\n    ) {\n        let pc = c + normalize(p1 + p2 - c - c) * length(p1 - c);\n        Triangle(c, p1, pc, color);\n        Triangle(c, pc, p2, color);\n    }\n\n    mark Sector4(\n        c: Vector2,\n        p1: Vector2,\n        p2: Vector2,\n        color: Color\n    ) {\n        let pc = c + normalize(p1 + p2 - c - c) * length(p1 - c);\n        Sector2(c, p1, pc, color);\n        Sector2(c, pc, p2, color);\n    }\n\n    mark Polyline(\n        p: Vector2, p_p: Vector2, p_n: Vector2, p_nn: Vector2,\n        width: float,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        let EPS = 1e-5;\n        let w = width / 2;\n        let d = normalize(p - p_n);\n        let n = Vector2(d.y, -d.x);\n        let m1: Vector2;\n        if(length(p - p_p) < EPS) {\n            m1 = n * w;\n        } else {\n            m1 = normalize(d + normalize(p - p_p)) * w;\n        }\n        let m2: Vector2;\n        if(length(p_n - p_nn) < EPS) {\n            m2 = -n * w;\n        } else {\n            m2 = normalize(normalize(p_n - p_nn) - d) * w;\n        }\n        let c1a: Vector2;\n        let c1b: Vector2;\n        let a1: Vector2;\n        let a2: Vector2;\n        if(dot(m1, n) > 0) {\n            c1a = p + m1;\n            c1b = p + n * w;\n            a2 = c1b;\n            a1 = p - m1 * (w / dot(m1, n));\n        } else {\n            c1a = p + m1;\n            c1b = p - n * w;\n            a2 = p + m1 * (w / dot(m1, n));\n            a1 = c1b;\n        }\n        let c2a: Vector2;\n        let c2b: Vector2;\n        let b1: Vector2;\n        let b2: Vector2;\n        if(dot(m2, n) < 0) {\n            c2a = p_n + m2;\n            c2b = p_n - n * w;\n            b1 = c2b;\n            b2 = p_n + m2 * (w / dot(m2, n));\n        } else {\n            c2a = p_n + m2;\n            c2b = p_n + n * w;\n            b2 = c2b;\n            b1 = p_n - m2 * (w / dot(m2, n));\n        }\n        emit [\n            { position: p, color: color },\n            { position: c1a, color: color },\n            { position: c1b, color: color }\n        ];\n        emit [\n            { position: p_n, color: color },\n            { position: c2a, color: color },\n            { position: c2b, color: color }\n        ];\n        emit [\n            { position: p, color: color },\n            { position: a1, color: color },\n            { position: b1, color: color }\n        ];\n        emit [\n            { position: p, color: color },\n            { position: b1, color: color },\n            { position: p_n, color: color }\n        ];\n        emit [\n            { position: p, color: color },\n            { position: a2, color: color },\n            { position: b2, color: color }\n        ];\n        emit [\n            { position: p, color: color },\n            { position: b2, color: color },\n            { position: p_n, color: color }\n        ];\n    }\n\n    mark Wedge(\n        p1: Vector2 = [ 0, 0 ],\n        theta1: float = 0,\n        theta2: float = 0,\n        length: float = 10,\n        width: float = 1,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        let dTheta = (theta2 - theta1) / 60;\n        let dL = length / 60;\n        for(i in 0..59) {\n            let dThetaA = i * dTheta;\n            let dThetaB = (i + 1) * dTheta;\n            let thetaA = theta1 + dThetaA;\n            let thetaB = theta1 + dThetaB;\n            let thetaCenterA = theta1 + dThetaA / 2;\n            let thetaCenterB = theta1 + dThetaB / 2;\n            let dlA = dL * i;\n            let dlB = dL * (i + 1);\n            if(dThetaA > 1e-5 || dThetaA < -1e-5) {\n                dlA = dlA / dThetaA * 2 * sin(dThetaA / 2);\n            }\n            if(dThetaB > 1e-5 || dThetaB < -1e-5) {\n                dlB = dlB / dThetaB * 2 * sin(dThetaB / 2);\n            }\n            let pAdvA = Vector2(-sin(thetaCenterA), cos(thetaCenterA)) * dlA;\n            let pAdvB = Vector2(-sin(thetaCenterB), cos(thetaCenterB)) * dlB;\n            let pA = p1 + pAdvA;\n            let pB = p1 + pAdvB;\n\n            let dpA = Vector2(cos(thetaA), sin(thetaA)) * width * 0.5;\n            let dpB = Vector2(cos(thetaB), sin(thetaB)) * width * 0.5;\n\n            Triangle(pA + dpA, pB + dpB, pB - dpB, color);\n            Triangle(pA + dpA, pB - dpB, pA - dpA, color);\n        }\n    }\n"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.primitives="\n    mark Triangle(\n        p1: Vector3,\n        p2: Vector3,\n        p3: Vector3,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        let normal = normalize(cross(p2 - p1, p3 - p1));\n        emit [\n            { position: p1, color: color, normal: normal },\n            { position: p2, color: color, normal: normal },\n            { position: p3, color: color, normal: normal }\n        ];\n    }\n\n    mark Tetrahedron(\n        p1: Vector3,\n        p2: Vector3,\n        p3: Vector3,\n        p4: Vector3,\n        color: Color = [ 0, 0, 0, 1 ]\n    ) {\n        Triangle(p3, p4, p1, color);\n        Triangle(p1, p4, p2, color);\n        Triangle(p1, p2, p3, color);\n        Triangle(p2, p3, p4, color);\n    }\n\n    mark Line(\n        p1: Vector3,\n        p2: Vector3,\n        width: float = 1,\n        color: Color = [ 1, 0, 1, 1 ]\n    ) {\n        let center = (p1 + p2) * 0.5;\n        let d = p2 - p1;\n        let v = get_camera_direction(center);\n        let F = normalize(cross(d, v));\n        let normal = normalize(cross(F, d));\n        let s = width * 0.5;\n        emit [\n            { position: p1 + F * s, color: color, normal: normal },\n            { position: p2 + F * s, color: color, normal: normal },\n            { position: p1 - F * s, color: color, normal: normal },\n            { position: p1 - F * s, color: color, normal: normal },\n            { position: p2 + F * s, color: color, normal: normal },\n            { position: p2 - F * s, color: color, normal: normal }\n        ];\n    }\n\n    mark Cube(\n        center: Vector3,\n        radius: float,\n        color: Color\n    ) {\n        let p000 = Vector3(center.x - radius, center.y - radius, center.z - radius);\n        let p001 = Vector3(center.x - radius, center.y - radius, center.z + radius);\n        let p010 = Vector3(center.x - radius, center.y + radius, center.z - radius);\n        let p011 = Vector3(center.x - radius, center.y + radius, center.z + radius);\n        let p100 = Vector3(center.x + radius, center.y - radius, center.z - radius);\n        let p101 = Vector3(center.x + radius, center.y - radius, center.z + radius);\n        let p110 = Vector3(center.x + radius, center.y + radius, center.z - radius);\n        let p111 = Vector3(center.x + radius, center.y + radius, center.z + radius);\n        let nx = Vector3(1, 0, 0);\n        let ny = Vector3(0, 1, 0);\n        let nz = Vector3(0, 0, 1);\n        emit [ { position: p000, color: color, normal: nz }, { position: p110, color: color, normal: nz }, { position: p100, color: color, normal: nz } ];\n        emit [ { position: p000, color: color, normal: nz }, { position: p010, color: color, normal: nz }, { position: p110, color: color, normal: nz } ];\n        emit [ { position: p001, color: color, normal: nz }, { position: p101, color: color, normal: nz }, { position: p111, color: color, normal: nz } ];\n        emit [ { position: p001, color: color, normal: nz }, { position: p111, color: color, normal: nz }, { position: p011, color: color, normal: nz } ];\n        emit [ { position: p000, color: color, normal: ny }, { position: p100, color: color, normal: ny }, { position: p101, color: color, normal: ny } ];\n        emit [ { position: p000, color: color, normal: ny }, { position: p101, color: color, normal: ny }, { position: p001, color: color, normal: ny } ];\n        emit [ { position: p010, color: color, normal: ny }, { position: p111, color: color, normal: ny }, { position: p110, color: color, normal: ny } ];\n        emit [ { position: p010, color: color, normal: ny }, { position: p011, color: color, normal: ny }, { position: p111, color: color, normal: ny } ];\n        emit [ { position: p000, color: color, normal: nx }, { position: p001, color: color, normal: nx }, { position: p011, color: color, normal: nx } ];\n        emit [ { position: p000, color: color, normal: nx }, { position: p011, color: color, normal: nx }, { position: p010, color: color, normal: nx } ];\n        emit [ { position: p100, color: color, normal: nx }, { position: p111, color: color, normal: nx }, { position: p101, color: color, normal: nx } ];\n        emit [ { position: p100, color: color, normal: nx }, { position: p110, color: color, normal: nx }, { position: p111, color: color, normal: nx } ];\n    }\n"},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(0),i=n(3),a=function(){function t(){var t=this;this._functions=new o.Dictionary,this._functionModule=new o.Dictionary,this._currentMoudles=[],i.forEachIntrinsicFunction(function(e){t.addIntrinsicFunction(e.name,{type:"function",isMark:!1,isShader:!1,name:e.internalName,returnType:e.returnType,arguments:e.argTypes.map(function(t,e){return{name:"a"+e,type:t}}),statements:null})})}return t.prototype.addIntrinsicFunction=function(t,e){if(this._functions.has(t)){(n=this._functions.get(t)).addFunction(e)}else{var n=new s(t);this._functions.set(t,n),n.addFunction(e)}},t.prototype.addFunction=function(t,e){if(this._functions.has(t)){(n=this._functions.get(t)).addFunction(e)}else{var n=new s(t);this._functions.set(t,n),n.addFunction(e)}},t.prototype.importFunction=function(t,e){this.addFunction(e,t.get(e)),this._functionModule.set(e,t)},t.prototype.getFunction=function(t){for(var e=this._currentMoudles.length-1;e>=0;e--){var n=this._currentMoudles[e];if(n&&n.has(t)){var r=new s(t);return r.addFunction(n.get(t)),r}}return this._functions.has(t)?this._functions.get(t):null},t.prototype.enterFunctionImplementation=function(t){this._currentMoudles.push(this._functionModule.get(t))},t.prototype.leaveFunctionImplementation=function(t){this._currentMoudles.pop()},t}();e.ModuleResolver=a;var s=function(){function t(t){this._name=t,this._functions=[]}return t.prototype.addFunction=function(t){this._functions.push(t)},t.prototype.resolveArguments=function(t,e){for(var n=null,o=null,i=0,a=this._functions;i<a.length;i++){var s=a[i],u=0,l=!0,p=[],f=[],h=[];for(var d in s.arguments){var v=s.arguments[d],m=t[d]||e[v.name];if(null!=t[d]?f.push(d):e[v.name]&&h.push(v.name),null!=m)if(m.valueType!=v.type){var _=c(m,v.type),y=_[0],g=_[1];if(!y){l=!1;break}p.push(y),u+=g}else p.push(m);else{if(null===v.default||void 0===v.default){l=!1;break}p.push({type:"constant",value:v.default,valueType:v.type})}}var x=!0;for(var d in t)f.indexOf(d)<0&&(x=!1);for(var b in e)h.indexOf(b)<0&&(x=!1);l&&x&&(!n||u<o)&&(n=[s,p],o=u)}if(n)return n;var V=t.map(function(t){return t.valueType}).join(", ");throw new r.CompileError("unable to resolve function '"+this._name+"' with arguments ("+V+")")},t}();function c(t,e){var n=i.getTypeConversion(t.valueType,e);if(n){var r=n.rank;return[{type:"function",valueType:e,arguments:[t],functionName:n.internalName},r]}return[null,null]}e.FunctionOverloadResolver=s,e.typeConversionAttempt=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=function(){function t(t,e,n){void 0===e&&(e=null),void 0===n&&(n=null),this._owner=t,this._variables=new r.Dictionary,this._parentScope=e||null,this._argMap=n}return t.prototype.addVariable=function(t,e){if(this._variables.has(t)||null!=this._argMap&&this._argMap.has(t))throw new r.CompileError(t+" is already declared.");var n=this._owner.newTranslatedName(t,e);this._variables.set(t,{name:t,type:e,translatedName:n})},t.prototype.nextVariable=function(t){var e=this,n=r.attemptName("tmp",function(t){return!(e._variables.has(t)||null!=e._argMap&&e._argMap.has(t))});return this.addVariable(n,t),this.getVariable(n)},t.prototype.getVariable=function(t){if(this._variables.has(t))return this._variables.get(t);if(null!=this._argMap&&this._argMap.has(t))return this._parentScope.getVariable(this._argMap.get(t));if(this._parentScope)return this._parentScope.getVariable(t);throw new r.CompileError(t+" is undefined.")},Object.defineProperty(t.prototype,"parentScope",{get:function(){return this._parentScope},enumerable:!0,configurable:!0}),t}();e.ScopeVariables=o;var i=function(){function t(){this._translatedNames=new r.Dictionary,this._globalScope=new o(this),this._currentScope=this._globalScope}return t.prototype.resetScope=function(){this._translatedNames=new r.Dictionary,this._globalScope=new o(this),this._currentScope=this._globalScope},t.prototype.pushScope=function(t){void 0===t&&(t=null),this._currentScope=new o(this,this._currentScope,t)},t.prototype.popScope=function(){this._currentScope=this._currentScope.parentScope},t.prototype.newTranslatedName=function(t,e){var n=this,o=r.attemptName(t,function(t){return!n._translatedNames.has(t)});return this._translatedNames.set(o,{name:t,type:e,translatedName:o}),o},t.prototype.forEach=function(t){this._translatedNames.forEach(function(e){t(e.translatedName,e.type)})},t.prototype.nextVariableTranslatedName=function(t){return this.nextVariable(t).translatedName},t.prototype.nextVariableName=function(t){return this.nextVariable(t).name},t.prototype.nextVariable=function(t){return this._currentScope.nextVariable(t)},t.prototype.addVariable=function(t,e,n){"global"==n?this._globalScope.addVariable(t,e):this._currentScope.addVariable(t,e)},t.prototype.translateVariableName=function(t){return this.getVariable(t).translatedName},t.prototype.getVariable=function(t){return this._currentScope.getVariable(t)},t}();e.ScopeStack=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(33);e.flattenEmits=r.flattenEmits},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(6).Construct,o=n(0);e.flattenEmits=function(t){var e=o.attemptName("s3idx",function(e){return!t.variables.hasOwnProperty(e)&&!t.input.hasOwnProperty(e)}),n=o.attemptName("s3idx_i",function(e){return!t.variables.hasOwnProperty(e)&&!t.input.hasOwnProperty(e)}),i=o.attemptName("s3emitidx",function(e){return!t.variables.hasOwnProperty(e)&&!t.input.hasOwnProperty(e)}),a={input:{},output:t.output,variables:t.variables,statements:[],repeatBegin:t.repeatBegin,repeatEnd:t.repeatEnd};for(var s in t.input)t.input.hasOwnProperty(s)&&(a.input[s]=t.input[s]);a.input[e]={type:"float",default:0},a.variables[n]="int",a.variables[i]="int",a.statements.push({type:"assign",variableName:n,expression:r.cast(r.variable(e,"float"),"int")}),a.statements.push({type:"assign",variableName:i,expression:r.constant(0,"int")});var c=function(t){for(var e=[],o=0,a=0;a<t.length;a++)switch(t[a].type){case"emit":e.push({type:"condition",condition:r.equals(r.variable(n,"int"),r.variable(i,"int")),trueStatements:[t[a]],falseStatements:[]}),e.push({type:"assign",variableName:i,expression:r.add(r.variable(i,"int"),r.constant(1,"int"))}),o+=1;break;case"for":var s=t[a],u=c(s.statements),l=u[0],p=u[1],f=[];f.push({type:"assign",variableName:s.variableName,expression:r.add(r.div(r.sub(r.variable(n,"int"),r.variable(i,"int")),r.constant(p,"int")),r.constant(s.rangeMin,"int"))}),f.push({type:"assign",variableName:i,expression:r.add(r.variable(i,"int"),r.mul(r.constant(p,"int"),r.sub(r.variable(s.variableName,"int"),r.constant(s.rangeMin,"int"))))}),(f=f.concat(l)).push({type:"assign",variableName:i,expression:r.add(r.variable(i,"int"),r.mul(r.constant(p,"int"),r.sub(r.constant(s.rangeMax,"int"),r.variable(s.variableName,"int"))))}),e.push({type:"condition",condition:r.op("&&","bool",r.greaterThanOrEquals(r.variable(n,"int"),r.variable(i,"int")),r.lessThan(r.variable(n,"int"),r.add(r.variable(i,"int"),r.constant(p*(s.rangeMax-s.rangeMin+1),"int")))),trueStatements:f,falseStatements:[{type:"assign",variableName:i,expression:r.add(r.variable(i,"int"),r.constant((s.rangeMax-s.rangeMin+1)*p,"int"))}]}),o+=(s.rangeMax-s.rangeMin+1)*p;break;case"condition":var h=t[a],d=c(h.trueStatements),v=d[0],m=d[1],_=c(h.falseStatements),y=_[0],g=_[1];e.push({type:"condition",condition:h.condition,trueStatements:v,falseStatements:y}),o=Math.max(m,g);break;default:e.push(t[a])}return[e,o]},u=c(t.statements),l=u[0],p=u[1];return a.statements=a.statements.concat(l),{specification:a,count:p,indexVariable:e}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(9);e.Mark=r.Mark;var o=n(16);e.CustomMark=o.CustomMark,e.CustomMarkItem=o.CustomMarkItem;var i=n(35);e.mark=i;var a=n(40);e.shader=a;var s=n(2);e.compile=s.compile},function(t,e,n){"use strict";function r(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0});var o=n(16),i=n(9),a=n(17),s=n(18);e.create=function(t,e,n){if(e instanceof a.Platform){var r=s.basic();if(t instanceof o.CustomMark){var c=t.compile();return null!=c.shader?new i.Mark(c,c.shader,e):new i.Mark(c,r,e)}return null!=t.shader?new i.Mark(t,t.shader,e):new i.Mark(t,r,e)}return r=e,t instanceof o.CustomMark?new i.Mark(t.compile(),r,n):new i.Mark(t,r,n)},e.custom=function(){return new o.CustomMark},r(n(36)),r(n(37));var c=n(38);e.createText=c.createText;var u=n(2);e.compile=u.compile},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(2);e.circle=function(){var t=r.compile("\n    mark Circle(\n      center: Vector2 = [ 0, 0 ],\n      radius: float = 1,\n      color: Color = [ 0, 0, 0, 1 ]\n    ) {\n      let rs = radius * 1.4142135624;\n      emit [\n        { position: center + Vector2(rs, 0), offset: Vector2(1, 1), color: color },\n        { position: center + Vector2(0, rs), offset: Vector2(-1, 1), color: color },\n        { position: center + Vector2(-rs, 0), offset: Vector2(-1, -1), color: color }\n      ];\n      emit [\n        { position: center + Vector2(-rs, 0), offset: Vector2(-1, -1), color: color },\n        { position: center + Vector2(0, -rs), offset: Vector2(1, -1), color: color },\n        { position: center + Vector2(rs, 0), offset: Vector2(1, 1), color: color }\n      ];\n    }\n    shader CircleShader(\n      color: Color,\n      offset: Vector2\n    ) {\n      let dist = dot(offset, offset);\n      if(dist > 1.0) {\n        discard;\n      } else {\n        emit { color: color };\n      }\n    }\n  ");return t.Circle.shader=t.CircleShader,t.Circle},e.rect=function(){return r.compile("\n    mark Rectangle(\n      p1: Vector2 = [ 0, 0 ],\n      p2: Vector2 = [ 0, 0 ],\n      color: Color = [ 0, 0, 0, 1 ]\n    ) {\n      emit [\n        { position: Vector2(p1.x, p1.y), color: color },\n        { position: Vector2(p2.x, p1.y), color: color },\n        { position: Vector2(p2.x, p2.y), color: color }\n      ];\n      emit [\n        { position: Vector2(p1.x, p1.y), color: color },\n        { position: Vector2(p1.x, p2.y), color: color },\n        { position: Vector2(p2.x, p2.y), color: color }\n      ];\n    }\n  ").Rectangle},e.line=function(){return r.compile("\n    mark Line(\n      p1: Vector2 = [ 0, 0 ],\n      p2: Vector2 = [ 0, 0 ],\n      width: float = 1,\n      color: Color = [ 0, 0, 0, 1 ]\n    ) {\n      let d = normalize(p2 - p1);\n      let t = Vector2(d.y, -d.x) * (width / 2);\n      emit [\n        { position: p1 + t, color: color },\n        { position: p1 - t, color: color },\n        { position: p2 + t, color: color }\n      ];\n      emit [\n        { position: p1 - t, color: color },\n        { position: p2 - t, color: color },\n        { position: p2 + t, color: color }\n      ];\n    }\n  ").Line},e.wedge=function(t){return void 0===t&&(t=60),r.compile("\n    import { Triangle } from P2D;\n\n    mark Wedge(\n      p1: Vector2 = [ 0, 0 ],\n      theta1: float = 0,\n      theta2: float = 0,\n      length: float = 10,\n      width: float = 1,\n      color: Color = [ 0, 0, 0, 1 ]\n    ) {\n      let dTheta = (theta2 - theta1) / 60;\n      let dL = length / 60;\n      for(i in 0..59) {\n        let dThetaA = i * dTheta;\n        let dThetaB = (i + 1) * dTheta;\n        let thetaA = theta1 + dThetaA;\n        let thetaB = theta1 + dThetaB;\n        let thetaCenterA = theta1 + dThetaA / 2;\n        let thetaCenterB = theta1 + dThetaB / 2;\n        let dlA = dL * i;\n        let dlB = dL * (i + 1);\n        if(dThetaA > 1e-5 || dThetaA < -1e-5) {\n          dlA = dlA / dThetaA * 2 * sin(dThetaA / 2);\n        }\n        if(dThetaB > 1e-5 || dThetaB < -1e-5) {\n          dlB = dlB / dThetaB * 2 * sin(dThetaB / 2);\n        }\n        let pAdvA = Vector2(-sin(thetaCenterA), cos(thetaCenterA)) * dlA;\n        let pAdvB = Vector2(-sin(thetaCenterB), cos(thetaCenterB)) * dlB;\n        let pA = p1 + pAdvA;\n        let pB = p1 + pAdvB;\n\n        let dpA = Vector2(cos(thetaA), sin(thetaA)) * width * 0.5;\n        let dpB = Vector2(cos(thetaB), sin(thetaB)) * width * 0.5;\n\n        Triangle(pA + dpA, pB + dpB, pB - dpB, color);\n        Triangle(pA + dpA, pB - dpB, pA - dpA, color);\n      }\n    }\n  ").Wedge},e.polyline=function(){var t=r.compile("\n    import { Triangle } from P2D;\n\n    mark Sector2(\n      c: Vector2,\n      p1: Vector2,\n      p2: Vector2,\n      color: Color\n    ) {\n      let pc = c + normalize(p1 + p2 - c - c) * length(p1 - c);\n      Triangle(c, p1, pc, color);\n      Triangle(c, pc, p2, color);\n    }\n\n    mark Sector4(\n      c: Vector2,\n      p1: Vector2,\n      p2: Vector2,\n      color: Color\n    ) {\n      let pc = c + normalize(p1 + p2 - c - c) * length(p1 - c);\n      Sector2(c, p1, pc, color);\n      Sector2(c, pc, p2, color);\n    }\n\n    mark PolylineRound(\n      p: Vector2, p_p: Vector2, p_n: Vector2, p_nn: Vector2,\n      width: float = 1,\n      color: Color = [ 0, 0, 0, 1 ]\n    ) {\n      let EPS = 1e-5;\n      let w = width / 2;\n      let d = normalize(p - p_n);\n      let n = Vector2(d.y, -d.x);\n      let m1: Vector2;\n      if(length(p - p_p) < EPS) {\n        m1 = n * w;\n      } else {\n        m1 = normalize(d + normalize(p - p_p)) * w;\n      }\n      let m2: Vector2;\n      if(length(p_n - p_nn) < EPS) {\n        m2 = -n * w;\n      } else {\n        m2 = normalize(normalize(p_n - p_nn) - d) * w;\n      }\n      let c1a: Vector2;\n      let c1b: Vector2;\n      let a1: Vector2;\n      let a2: Vector2;\n      if(dot(m1, n) > 0) {\n        c1a = p + m1;\n        c1b = p + n * w;\n        a2 = c1b;\n        a1 = p - m1 * (w / dot(m1, n));\n      } else {\n        c1a = p + m1;\n        c1b = p - n * w;\n        a2 = p + m1 * (w / dot(m1, n));\n        a1 = c1b;\n      }\n      let c2a: Vector2;\n      let c2b: Vector2;\n      let b1: Vector2;\n      let b2: Vector2;\n      if(dot(m2, n) < 0) {\n        c2a = p_n + m2;\n        c2b = p_n - n * w;\n        b1 = c2b;\n        b2 = p_n + m2 * (w / dot(m2, n));\n      } else {\n        c2a = p_n + m2;\n        c2b = p_n + n * w;\n        b2 = c2b;\n        b1 = p_n - m2 * (w / dot(m2, n));\n      }\n      Sector4(p, c1a, c1b, color);\n      Sector4(p_n, c2a, c2b, color);\n      Triangle(p, a1, b1, color);\n      Triangle(p, b1, p_n, color);\n      Triangle(p, a2, b2, color);\n      Triangle(p, b2, p_n, color);\n    }\n  ").PolylineRound;return t.repeatBegin=1,t.repeatEnd=1,t}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(2);e.circle3d=function(){var t=r.compile("\n    mark Circle(\n      center: Vector3 = [0, 0, 0],\n      radius: float = 0.1,\n      color: Color = [1, 1, 1, 1]\n    ) {\n      let camera_direction = get_camera_direction(center);\n      let ex = normalize(cross(camera_direction, Vector3(0, 1, 0)));\n      let ey = cross(camera_direction, ex);\n      let p1 = center + ex * radius + ey * radius;\n      let p2 = center + ex * radius - ey * radius;\n      let p3 = center - ex * radius - ey * radius;\n      let p4 = center - ex * radius + ey * radius;\n      emit [\n        { position: p1, color: color, off: Vector2(1, 1) },\n        { position: p3, color: color, off: Vector2(-1, -1) },\n        { position: p2, color: color, off: Vector2(1, -1) },\n        { position: p1, color: color, off: Vector2(1, 1) },\n        { position: p4, color: color, off: Vector2(-1, 1) },\n        { position: p3, color: color, off: Vector2(-1, -1) }\n      ];\n    }\n    shader CircleShader(color: Color, off: Vector2) {\n      let r = length(off);\n      if(r > 1 || color.a < 0.001) {\n        discard;\n      } else {\n        emit { color: color };\n      }\n    }\n  ");return t.Circle.shader=t.CircleShader,t.Circle},e.line3d=function(){return r.compile("\n    import { Line } from P3D;\n    mark Line3D(\n      p1: Vector3 = [0, 0, 0],\n      p2: Vector3 = [0, 0, 0],\n      width: float = 0.1,\n      color: Color = [1, 1, 1, 1]\n    ) {\n      Line(p1, p2, width, color);\n    }\n  ").Line3D},e.polyline3d=function(){return r.compile("\n    import { Line } from P3D;\n    mark Line3D(\n      p: Vector3 = [0, 0, 0],\n      p_n: Vector3 = [0, 0, 0],\n      width: float = 0.1,\n      color: Color = [1, 1, 1, 1]\n    ) {\n      Line(p, p_n, width, color);\n    }\n  ").Line3D}},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(9),a=n(14),s=n(2),c=n(39),u=function(t){function e(e,n){void 0===e&&(e="2d");var r=t.call(this,s.compile("\n        mark TextMark(\n          position: "+("2d"==e?"Vector2":"Vector3")+",\n          normal: Vector3 = [ 0, 0, 1 ],\n          up: "+("2d"==e?"Vector2 = [ 0, 1 ]":"Vector3 = [ 0, 1, 0 ]")+",\n          scale: float = 1,\n          color: Color = [ 0, 0, 0, 1 ],\n          alignX: float = 0,\n          alignY: float = 0,\n          mScaling: float,\n          mImage: Image,\n          mTextInfo: Vector4Array,\n          mIndex: float\n        ) {\n          let p = "+("2d"==e?"Vector3(position.x, position.y, 0)":"position")+";\n          let info = array(mTextInfo, mIndex);\n          let e1 = normalize(cross("+("2d"==e?"Vector3(up.x, up.y, 0)":"up")+", normal)) * info.x * (scale / mScaling);\n          let e2 = normalize(cross(normal, e1)) * info.y * (scale / mScaling);\n          p = p - e1 * alignX - e2 * (1 - alignY);\n          let mSizeX = Vector2(info.x, 0);\n          let mSizeY = Vector2(0, info.y);\n          let mTexPos = Vector2(info.z, info.w);\n          emit [\n              { position: p, tp: mTexPos, color: color },\n              { position: p + e1, tp: mTexPos + mSizeX, color: color },\n              { position: p + e1 + e2, tp: mTexPos + mSizeX + mSizeY, color: color },\n              { position: p, tp: mTexPos, color: color },\n              { position: p + e1 + e2, tp: mTexPos + mSizeX + mSizeY, color: color },\n              { position: p + e2, tp: mTexPos + mSizeY, color: color }\n          ];\n        }\n      ").TextMark,s.compile("\n        shader TextShader(\n          tp: Vector2,\n          mImage: Image,\n          color: Color\n        ) {\n          let c = image(mImage, tp);\n          let alpha = c.a;\n          if(alpha == 0) {\n            discard;\n          } else {\n            emit { color: Color(color.r, color.g, color.b, alpha * color.a) };\n          }\n        }\n      ").TextShader,n)||this;return r._textBinding="text",r._fontFamilyBinding="Arial",r._fontSizeBinding=12,r._fontWeightBinding="normal",r._fontStyleBinding="normal",r._textCache=new c.TextCache(1024,1024),r._image=new a.Image,r._textInfo=new a.ArrayBinding,r.attr("mScaling",r._textCache.scaling),r.attr("mImage",r._image),r.attr("mIndex",function(t,e){return e}),r.attr("mTextInfo",r._textInfo),r._shouldRefreshCanvas=!0,r}return o(e,t),e.prototype.prepare=function(){var e=this;if(this._shouldRefreshCanvas){var n=this.data(),r=new a.Binding("string",this._textBinding).map(n),o=new a.Binding("string",this._fontFamilyBinding).map(n),i=new a.Binding("string",this._fontSizeBinding).map(n),s=new a.Binding("string",this._fontWeightBinding).map(n),u=new a.Binding("string",this._fontStyleBinding).map(n),l=function(){e._textLayouts=r.map(function(t,n){var r=new c.Font(o[n].toString(),i[n],s[n].toString(),u[n].toString()),a=e._textCache.addText(t.toString(),r);return{size:[a.w,a.h],position:[a.x,a.y]}})};try{l()}catch(t){this._textCache.clear(),l()}this._textInfo.data(r),this._textInfo.value(function(t,n){return[e._textLayouts[n].size[0],e._textLayouts[n].size[1],e._textLayouts[n].position[0],e._textLayouts[n].position[1]]}),this.attr("mTextInfo",this._textInfo),this._textCache.updated&&(this._image.setImage(this._textCache.canvas),this.attr("mImage",this._image),this._textCache.updated=!1),this._shouldRefreshCanvas=!1}return t.prototype.prepare.call(this)},e.prototype.attr=function(e,n){switch(e){case"text":return void 0===n?this._textBinding:(this._textBinding=n,this._shouldRefreshCanvas=!0,this);case"fontFamily":return void 0===n?this._fontFamilyBinding:(this._fontFamilyBinding=n,this._shouldRefreshCanvas=!0,this);case"fontSize":return void 0===n?this._fontSizeBinding:(this._fontSizeBinding=n,this._shouldRefreshCanvas=!0,this);case"fontWeight":return void 0===n?this._fontWeightBinding:(this._fontWeightBinding=n,this._shouldRefreshCanvas=!0,this);case"fontStyle":return void 0===n?this._fontStyleBinding:(this._fontStyleBinding=n,this._shouldRefreshCanvas=!0,this);default:return t.prototype.attr.call(this,e,n)}},e.prototype.data=function(e){return void 0===e?t.prototype.data.call(this):(t.prototype.data.call(this,e),this._shouldRefreshCanvas=!0,this)},e}(i.Mark);e.TextMark=u,e.createText=function(t,e){return new u(t,e)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){void 0===t&&(t="Arial"),void 0===e&&(e=12),void 0===n&&(n="normal"),void 0===r&&(r="normal"),this.fontFamily=t,this.fontSize=e,this.fontWeight=n,this.fontStyle=r}return t.prototype.hash=function(){return"F"+this.fontFamily+","+this.fontSize+","+this.fontWeight+","+this.fontStyle},t.prototype.setFont=function(t){t.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+JSON.stringify(this.fontFamily)},t}();e.Font=r;var o=function(){function t(t,e,n){void 0===t&&(t=1024),void 0===e&&(e=1024),void 0===n&&(n=2),this.entries={},this.current_x=0,this.current_y=0,this.current_height=0,this.width=t,this.height=e,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.canvas.width=this.width*n,this.canvas.height=this.height*n,this.scaling=n,this.context.scale(n,n),this.context.fillStyle="#000000"}return t.prototype.addText=function(t,e){var n=JSON.stringify(t)+e.hash();if(this.entries[n])return this._layout2TextRect(this.entries[n]);e.setFont(this.context);var r=this.context.measureText(t).width,o=e.fontSize,i=Math.ceil(r+4),a=Math.ceil(o+2),s=o-2;if(i>this.width)throw new Error("E_FIT");if(this.current_x+i>this.width){if(this.current_y+this.current_height+a>this.height)throw new Error("E_FIT");this.current_x=0,this.current_y+=this.current_height,this.current_height=a}var c={x:this.current_x,y:this.current_y,x_offset:2,baseline_offset:s,bbox_width:i,bbox_height:a};this.current_x+=i,this.current_height=Math.max(this.current_height,a),this.entries[n]=c;var u=c.x+2,l=c.y+s;return this.context.fillText(t,u,l),this.updated=!0,this._layout2TextRect(c)},t.prototype._layout2TextRect=function(t){return{x:t.x*this.scaling,y:t.y*this.scaling,w:t.bbox_width*this.scaling,h:t.bbox_height*this.scaling,scaling:this.scaling,x_offset:t.x_offset*this.scaling,baseline_offset:t.baseline_offset*this.scaling}},t.prototype.getTextRect=function(t,e){var n=JSON.stringify(t)+e.hash(),r=this.entries[n];return r?this._layout2TextRect(r):null},t.prototype.clear=function(){this.entries={},this.current_x=0,this.current_y=0,this.current_height=0,this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.updated=!0},t}();e.TextCache=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),function(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}(n(18));var r=n(2);e.compile=r.compile},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(10);e.ScaleBinding=r.ScaleBinding;var o=n(42);e.scale=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),o=n(7),i=n(4),a=n(6),s=n(10),c=a.Construct;function u(){var t=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,t,"float",["float","float"]].concat(e)))};return t.getAttributes=function(){return[]},t.getExpression=function(t,e,n){return c.add(e,n)},t}function l(){var t=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,t,"float",["float","float"]].concat(e)))};return t.getAttributes=function(){return[]},t.getExpression=function(t,e,n){return c.sub(e,n)},t}function p(){var t=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,t,"float",["float","float"]].concat(e)))};return t.getAttributes=function(){return[]},t.getExpression=function(t,e,n){return c.mul(e,n)},t}function f(){var t=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,t,"float",["float","float"]].concat(e)))};return t.getAttributes=function(){return[]},t.getExpression=function(t,e,n){return c.div(e,n)},t}function h(){var t=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,t,"Vector2",["float","float"]].concat(e)))};return t.getAttributes=function(){return[]},t.getExpression=function(t,e,n){return c.func("Vector2","Vector2",e,n)},t}e.linear=function(t){void 0===t&&(t="float");var e=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,e,t,["float"]].concat(n)))},n=[0,1],r=[0,1];return e.domain=function(t){return null==t?n:(n[0]=t[0],n[1]=t[1],e)},e.range=function(t){return null==t?r:(r[0]=t[0],r[1]=t[1],e)},e.getAttributes=function(){return[{name:"d0",type:t,binding:n[0]},{name:"d1",type:t,binding:n[1]},{name:"r0",type:t,binding:r[0]},{name:"r1",type:t,binding:r[1]}]},e.getExpression=function(t,e){return c.mix(t.r0,t.r1,c.div(c.sub(e,t.d0),c.sub(t.d1,t.d0)))},e},e.log=function(t){void 0===t&&(t="float");var e=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,e,t,["float"]].concat(n)))},n=[0,1],r=[0,1];return e.domain=function(t){return null==t?n:(n[0]=t[0],n[1]=t[1],e)},e.range=function(t){return null==t?r:(r[0]=t[0],r[1]=t[1],e)},e.getAttributes=function(){return[{name:"d0",type:t,binding:n[0]},{name:"d1",type:t,binding:n[1]},{name:"r0",type:t,binding:r[0]},{name:"r1",type:t,binding:r[1]}]},e.getExpression=function(t,e){return c.mix(t.r0,t.r1,c.div(c.log(c.div(e,t.d0)),c.log(c.div(t.d1,t.d0))))},e},e.addScale=u,e.subScale=l,e.mulScale=p,e.divScale=f,e.vector2Scale=h,e.add=function(t,e){return u()(t,e)},e.sub=function(t,e){return l()(t,e)},e.mul=function(t,e){return p()(t,e)},e.div=function(t,e){return f()(t,e)},e.interpolate=function(t){void 0===t&&(t="float");var e,n=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,n,t,[t,t]].concat(e)))};return n.t=function(t){return null==t?e:(e=t,n)},n.getAttributes=function(){return[{name:"t",type:"float",binding:e}]},n.getExpression=function(t,e,n){return c.mix(e,n,t.t)},n},e.Vector2=function(t,e){return h()(t,e)},e.custom=function(t){var e=i.parseExpression(t),n=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var c=new r.Dictionary;a.forEach(function(t,e){c.set(e,{type:"constant",valueType:t.type,value:null})}),c.set("value",{type:"constant",valueType:"float",value:null});var u=o.compileExpression(e,c);return new(s.ScaleBinding.bind.apply(s.ScaleBinding,[void 0,n,u.valueType,["float"]].concat(t)))},a=new r.Dictionary;return n.attr=function(t,e,r){return null==e&&null==r?a.get(t).value:"string"==typeof e?(a.set(t,{type:e,value:r}),n):(a.set(t,{type:"float",value:e}),n)},n.getAttributes=function(){var t=[];return a.forEach(function(e,n){t.push({name:n,type:e.type,binding:e.value})}),t},n.getExpression=function(t,n){var i=new r.Dictionary;for(var a in t)t.hasOwnProperty(a)&&i.set(a,t[a]);return i.set("value",n),o.compileExpression(e,i)},n}},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i,a,s=n(1),c=n(44);!function(t){t[t.NORMAL=0]="NORMAL",t[t.PICK=1]="PICK",t[t.FRAGMENT=2]="FRAGMENT"}(i=e.GenerateMode||(e.GenerateMode={})),function(t){t[t.VIEW_2D=0]="VIEW_2D",t[t.VIEW_3D=1]="VIEW_3D",t[t.VIEW_MATRIX=2]="VIEW_MATRIX"}(a=e.ViewType||(e.ViewType={}));var u=function(t){function e(e){var n=t.call(this)||this;return n._parent=e,n}return o(e,t),e.prototype.addEmitStatement=function(t){for(var e in t.attributes)this.addLine(this._parent._voutMapping.get(e)+" = "+this.generateExpression(t.attributes[e])+";");this._parent._mode==i.PICK&&this.addLine("out_pick_index = vec4(s3_pick_index.rgb, s3_pick_index_alpha);");var n=this._parent._voutMapping.get("position");switch(this._parent._spec.output.position.type){case"Vector2":this.addLine("gl_Position = s3_render_vertex(vec3("+n+", 0.0));");break;case"Vector3":this.addLine("gl_Position = s3_render_vertex("+n+");");break;case"Vector4":this.addLine("gl_Position = s3_render_vertex("+n+".xyz);")}},e}(c.ShaderGenerator);e.GLSLVertexShaderGenerator=u;var l=function(t){function e(e){var n=t.call(this)||this;return n._parent=e,n}return o(e,t),e.prototype.addEmitStatement=function(t){this.addLine("gl_FragColor = "+this.generateExpression(t.attributes.color)+";")},e}(c.ShaderGenerator);e.GLSLFragmentShaderGenerator=l;var p=function(t){function e(e,n,r,o,a){void 0===a&&(a=i.NORMAL);var s=t.call(this,e,n,r)||this;return s._mode=a,s._viewType=o,s._vertex=new u(s),s._fragment=new l(s),s.compile(),s}return o(e,t),e.prototype.compile=function(){var t=this,e=this._spec,n=this._shader,r=this._asUniform;switch(this._voutMapping=new s.Dictionary,this._foutMapping=new s.Dictionary,this._vertex.addLine("precision highp float;"),this._fragment.addLine("precision highp float;"),this._mode==i.PICK&&(this._vertex.addAttribute("s3_pick_index","Vector4"),this._vertex.addUniform("s3_pick_index_alpha","float")),this._viewType){case a.VIEW_2D:this._vertex.addUniform("s3_view_params","Vector4"),this._vertex.addAdditionalCode("\n            vec4 s3_render_vertex(vec3 p) {\n              return vec4(p.xy * s3_view_params.xy + s3_view_params.zw, 0.0, 1.0);\n            }\n          ");break;case a.VIEW_3D:this._vertex.addUniform("s3_view_params","Vector4"),this._vertex.addUniform("s3_view_position","Vector3"),this._fragment.addUniform("s3_view_position","Vector3"),this._vertex.addUniform("s3_view_rotation","Vector4"),this._vertex.addAdditionalCode("\n            vec4 s3_render_vertex(vec3 p) {\n              // Get position in view coordinates:\n              vec3 v = p - s3_view_position;\n              float d = dot(s3_view_rotation.xyz, v);\n              vec3 c = cross(s3_view_rotation.xyz, v);\n              v = s3_view_rotation.w * s3_view_rotation.w * v - (s3_view_rotation.w + s3_view_rotation.w) * c + d * s3_view_rotation.xyz - cross(c, s3_view_rotation.xyz);\n              // Compute projection.\n              vec4 r;\n              r.xy = v.xy * s3_view_params.xy;\n              r.z = v.z * s3_view_params.z + s3_view_params.w;\n              r.w = -v.z;\n              return r;\n            }\n          ");break;case a.VIEW_MATRIX:this._vertex.addUniform("s3_projection_matrix","Matrix4"),this._vertex.addUniform("s3_view_matrix","Matrix4"),this._vertex.addUniform("s3_view_position","Vector3"),this._vertex.addUniform("s3_view_rotation","Vector4"),this._vertex.addAdditionalCode("\n            vec4 s3_render_vertex(vec3 p) {\n              vec3 v = p - s3_view_position;\n              float d = dot(s3_view_rotation.xyz, v);\n              vec3 c = cross(s3_view_rotation.xyz, v);\n              v = s3_view_rotation.w * s3_view_rotation.w * v - (s3_view_rotation.w + s3_view_rotation.w) * c + d * s3_view_rotation.xyz - cross(c, s3_view_rotation.xyz);\n              return s3_projection_matrix * s3_view_matrix * vec4(v, 1);\n            }\n          ")}for(var o in this._viewType==a.VIEW_2D?[this._vertex,this._fragment].forEach(function(t){return t.addAdditionalCode("\n          vec3 s3_get_camera_position() {\n            return vec3(0, 0, 1);\n          }\n          vec3 s3_get_camera_direction(vec3 p) {\n            return vec3(0, 0, 1);\n          }\n        ")}):[this._vertex,this._fragment].forEach(function(t){t.addUniform("s3_camera_position","Vector3"),t.addAdditionalCode("\n          vec3 s3_get_camera_position() {\n            return s3_camera_position;\n          }\n          vec3 s3_get_camera_direction(vec3 p) {\n            return normalize(s3_camera_position - p);\n          }\n        ")}),e.input)e.input.hasOwnProperty(o)&&(r(o)?this._vertex.addUniform(o,e.input[o].type):this._vertex.addAttribute(o,e.input[o].type));for(var c in this._vertex.addLine("@additionalCode"),e.output)if(e.output.hasOwnProperty(c)){var u=this.getUnusedName(c);this._voutMapping.set(c,u),this._vertex.addVarying(u,e.output[c].type)}var l=[];for(var p in n.input){if(n.input.hasOwnProperty(p))if(this.fragmentPassthru(p))if(this._asUniform(p))this._fragment.addUniform(p,n.input[p].type);else{var f=this.getUnusedName(p);l.push([f,p]),this._vertex.addVarying(f,n.input[p].type),this._fragment.addVarying(f,n.input[p].type)}else(f=this._voutMapping.get(p))?this._fragment.addVarying(f,n.input[p].type):this._fragment.addUniform(p,n.input[p].type)}for(var h in this._mode==i.PICK&&this._vertex.addVarying("out_pick_index","Vector4"),this._vertex.addLine("void main() {"),this._vertex.indent(),e.variables)if(e.variables.hasOwnProperty(h)){var d=e.variables[h];this._vertex.addDeclaration(h,d)}if(this._vertex.addStatements(e.statements),this._vertex.unindent(),this._vertex.addLine("}"),this._vertexCode=this._vertex.getCode(),this._mode==i.PICK)this._fragmentCode="\n        precision highp float;\n        varying vec4 out_pick_index;\n        void main() {\n          gl_FragColor = out_pick_index;\n        }\n      ";else{for(var v in n.output)if(n.output.hasOwnProperty(v)){u=this.getUnusedName(v);this._foutMapping.set(v,u),this._fragment.addDeclaration(u,n.output[v].type)}for(var m in this._fragment.addLine("@additionalCode"),this._fragment.addLine("void main() {"),this._fragment.indent(),n.variables)if(n.variables.hasOwnProperty(m)){d=n.variables[m];this._fragment.addDeclaration(m,d)}var _=function(e){n.input.hasOwnProperty(e)&&(y.fragmentPassthru(e)?l.forEach(function(n){var r=n[0];n[1]==e&&t._fragment.addLine(e+" = "+r+";")}):y._voutMapping.get(e)&&(y._fragment.addDeclaration(e,n.input[e].type),y._fragment.addLine(e+" = "+y._voutMapping.get(e)+";")))},y=this;for(var g in n.input)_(g);this._fragment.addStatements(n.statements),this._fragment.unindent(),this._fragment.addLine("}"),this._fragmentCode=this._fragment.getCode()}},e.prototype.getVertexCode=function(){return this._vertexCode},e.prototype.getFragmentCode=function(){return this._fragmentCode},e}(c.ProgramGenerator);e.Generator=p},function(t,e,n){"use strict";var r,o=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var i=n(45),a=n(46),s=n(1),c=function(){function t(){this._lines=[],this._currentIndent="",this._blocks=new s.Dictionary}return t.prototype.addNamedBlock=function(t,e){this._blocks.has(t)?this._blocks.set(t,this._blocks.get(t)+"\n"+e):this._blocks.set(t,e)},t.prototype.addLine=function(t){this._lines.push(this._currentIndent+t)},t.prototype.indent=function(){this._currentIndent+="    "},t.prototype.unindent=function(){this._currentIndent=this._currentIndent.slice(0,this._currentIndent.length-4)},t.prototype.getCode=function(){var t=this;return this._lines.map(function(e){return"@"==e[0]?t._blocks.has(e.substr(1))?t._blocks.get(e.substr(1)):"":e}).join("\n")},t}();e.LinesGenerator=c;var u=function(t){function e(){return t.call(this)||this}return o(e,t),e.prototype.addAdditionalCode=function(t){this.addNamedBlock("additionalCode",t)},e.prototype.addDeclaration=function(t,e,n){void 0===n&&(n=null),null==n?this.addLine(i.convertTypeName(e)+" "+t+";"):this.addLine(n+" "+i.convertTypeName(e)+" "+t+";")},e.prototype.addArrayDeclaration=function(t,e,n,r){void 0===n&&(n=1),void 0===r&&(r=null),"null"==r?this.addLine(i.convertTypeName(e)+"["+n+"] "+t+";"):this.addLine(r+" "+i.convertTypeName(e)+"["+n+"] "+t+";")},e.prototype.addUniform=function(t,e){this.addLine("uniform "+i.convertTypeName(e)+" "+t+";"),"Vector2Array"!=e&&"FloatArray"!=e&&"Vector3Array"!=e&&"Vector4Array"!=e&&"ColorArray"!=e||this.addLine("uniform float "+t+"_length;"),"Vector2Image"!=e&&"FloatImage"!=e&&"Vector3Image"!=e&&"Vector4Image"!=e&&"Image"!=e||(this.addLine("uniform float "+t+"_width;"),this.addLine("uniform float "+t+"_height;"))},e.prototype.addAttribute=function(t,e){this.addLine("attribute "+i.convertTypeName(e)+" "+t+";")},e.prototype.addVarying=function(t,e){this.addLine("varying "+i.convertTypeName(e)+" "+t+";")},e.prototype.addIn=function(t,e){this.addLine("in "+i.convertTypeName(e)+" "+t+";")},e.prototype.addOut=function(t,e){this.addLine("out "+i.convertTypeName(e)+" "+t+";")},e.prototype.generateExpression=function(t){var e=this;switch(t.type){case"constant":var n=t;return i.convertConstant(n.valueType,n.value);case"variable":return t.variableName;case"function":var r=t,o=r.arguments.map(function(t){return e.generateExpression(t)}),s=a.generateIntrinsicFunction(r.functionName,o),c=s.code,u=s.additionalCode;return null!=u&&this.addAdditionalCode(u),c;case"field":var l=t;return this.generateExpression(l.value)+"."+l.fieldName}},e.prototype.addStatement=function(t){switch(t.type){case"assign":var e=t,n=this.generateExpression(e.expression);this.addLine(e.variableName+" = "+n+";");break;case"condition":var r=t;r.trueStatements.length>0&&r.falseStatements.length>0?(this.addLine("if("+this.generateExpression(r.condition)+") {"),this.indent(),this.addStatements(r.trueStatements),this.unindent(),this.addLine("} else {"),this.indent(),this.addStatements(r.falseStatements),this.unindent(),this.addLine("}")):r.trueStatements.length>0?(this.addLine("if("+this.generateExpression(r.condition)+") {"),this.indent(),this.addStatements(r.trueStatements),this.unindent(),this.addLine("}")):r.falseStatements.length>0&&(this.addLine("if(!"+this.generateExpression(r.condition)+") {"),this.indent(),this.addStatements(r.trueStatements),this.unindent(),this.addLine("}"));break;case"for":var o=t;this.addLine("for(int "+o.variableName+" = "+o.rangeMin+"; "+o.variableName+" <= "+o.rangeMax+"; "+o.variableName+"++) {"),this.indent(),this.addStatements(o.statements),this.unindent(),this.addLine("}");break;case"emit":var i=t;this.addEmitStatement(i);break;case"discard":this.addLine("discard;")}},e.prototype.addStatements=function(t){var e=this;t.forEach(function(t){return e.addStatement(t)})},e.prototype.addEmitStatement=function(t){this.addLine("// Emit Statement")},e}(c);e.ShaderGenerator=u;var l=function(){function t(t,e,n){var r=this;this._spec=t,this._shader=e,this._asUniform=n,this._names={};var o=function(t){for(var e in t)t.hasOwnProperty(e)&&(r._names[e]=!0)};o(t.input),o(t.output),o(t.variables),o(e.input),o(e.output)}return t.prototype.getUnusedName=function(t){for(var e=0;;){var n="s3"+t+e.toString();if(!0!==this._names[n])return this._names[n]=!0,n;e+=1}},t.prototype.fragmentPassthru=function(t){return this._spec.input.hasOwnProperty(t)&&!this._spec.output.hasOwnProperty(t)},t}();e.ProgramGenerator=l},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r={float:"float",int:"int",bool:"bool",Vector2:"vec2",Vector3:"vec3",Vector4:"vec4",Matrix3:"mat3",Matrix4:"mat4",Quaternion:"vec4",Color:"vec4",Image:"sampler2D",FloatArray:"sampler2D",Vector2Array:"sampler2D",Vector3Array:"sampler2D",Vector4Array:"sampler2D"};e.convertTypeName=function(t){return r[t]},e.convertConstant=function(t,e){return"float"==t?e.toFixed(5):"int"==t?e.toString():"bool"==t?0!=e?"true":"false":"Vector2"==t?"vec2("+e.join(", ")+")":"Vector3"==t?"vec3("+e.join(", ")+")":"Vector4"==t?"vec4("+e.join(", ")+")":"Quaternion"==t?"vec4("+e.join(", ")+")":"Color"==t?"vec4("+e.join(", ")+")":void 0}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),o=n(1),i=new o.Dictionary,a=new o.Dictionary;function s(t,e,n,o){var a=r.Intrinsics.getInternalName({name:t,argTypes:e,returnType:n});i.set(a,o)}function c(t,e,n,o,i){if(s(t,e,n,function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return o+"("+t.join(", ")+")"}),i){var c=r.Intrinsics.getInternalName({name:t,argTypes:e,returnType:n});a.set(c,i)}}function u(t,e,n,r){s("@"+t,e,n,r)}function l(t,e,n){s("cast:"+t+":"+e,[t],e,n)}for(var p=0,f=["float","int","Vector2","Vector3","Vector4","Color"];p<f.length;p++){u("+",[_=f[p],_],_,function(t,e){return"("+t+") + ("+e+")"}),u("-",[_,_],_,function(t,e){return"("+t+") - ("+e+")"}),u("*",[_,_],_,function(t,e){return"("+t+") * ("+e+")"}),u("/",[_,_],_,function(t,e){return"("+t+") / ("+e+")"}),"Color"!=_&&(u("+",[_],_,function(t,e){return""+t}),u("-",[_],_,function(t,e){return"-("+t+")"}))}u("*",["float","Vector2"],"Vector2",function(t,e){return"("+t+") * ("+e+")"}),u("*",["float","Vector3"],"Vector3",function(t,e){return"("+t+") * ("+e+")"}),u("*",["float","Vector4"],"Vector4",function(t,e){return"("+t+") * ("+e+")"}),u("*",["Vector2","float"],"Vector2",function(t,e){return"("+t+") * ("+e+")"}),u("*",["Vector3","float"],"Vector3",function(t,e){return"("+t+") * ("+e+")"}),u("*",["Vector4","float"],"Vector4",function(t,e){return"("+t+") * ("+e+")"}),u("/",["Vector2","float"],"Vector2",function(t,e){return"("+t+") / ("+e+")"}),u("/",["Vector3","float"],"Vector3",function(t,e){return"("+t+") / ("+e+")"}),u("/",["Vector4","float"],"Vector4",function(t,e){return"("+t+") / ("+e+")"}),u("%",["float","float"],"float",function(t,e){return"mod("+t+", "+e+")"});for(var h=0,d=["float","int","bool"];h<d.length;h++){u("==",[_=d[h],_],"bool",function(t,e){return"("+t+") == ("+e+")"})}for(var v=0,m=["float","int"];v<m.length;v++){var _;u(">",[_=m[v],_],"bool",function(t,e){return"("+t+") > ("+e+")"}),u("<",[_,_],"bool",function(t,e){return"("+t+") < ("+e+")"}),u(">=",[_,_],"bool",function(t,e){return"("+t+") >= ("+e+")"}),u("<=",[_,_],"bool",function(t,e){return"("+t+") <= ("+e+")"})}u("!",["bool"],"bool",function(t){return"!("+t+")"}),u("&&",["bool","bool"],"bool",function(t,e){return"("+t+") && ("+e+")"}),u("||",["bool","bool"],"bool",function(t,e){return"("+t+") || ("+e+")"}),c("Vector2",["float","float"],"Vector2","vec2"),c("Vector3",["float","float","float"],"Vector3","vec3"),c("Vector4",["float","float","float","float"],"Vector4","vec4"),c("Color",["float","float","float","float"],"Color","vec4"),c("Quaternion",["float","float","float","float"],"Quaternion","vec4"),c("normalize",["Vector2"],"Vector2","normalize"),c("normalize",["Vector3"],"Vector3","normalize"),c("normalize",["Vector4"],"Vector4","normalize"),c("normalize",["Quaternion"],"Vector4","normalize"),c("dot",["Vector2","Vector2"],"float","dot"),c("dot",["Vector3","Vector3"],"float","dot"),c("dot",["Vector4","Vector4"],"float","dot"),c("length",["Vector2"],"float","length"),c("length",["Vector3"],"float","length"),c("length",["Vector4"],"float","length"),c("length",["Quaternion"],"float","length"),c("cross",["Vector3","Vector3"],"Vector3","cross"),c("quat_mul",["Quaternion","Quaternion"],"Quaternion","s3_quat_mul","\n    vec4 s3_quat_mul(vec4 q1, vec4 q2) {\n        return vec4(\n            q1.w * q2.xyz + q2.w * q1.xyz + cross(q1.xyz, q2.xyz),\n            q1.w * q2.w - dot(q1.xyz, q2.xyz)\n        );\n    }\n"),c("quat_rotate",["Quaternion","Vector3"],"Vector3","s3_quat_rotate","\n    vec3 s3_quat_rotate(vec4 q, vec3 v) {\n        float d = dot(q.xyz, v);\n        vec3 c = cross(q.xyz, v);\n        return q.w * q.w * v + (q.w + q.w) * c + d * q.xyz - cross(c, q.xyz);\n    }\n");var y="\n    float s3_lab2rgb_curve(float v) {\n        float p = pow(v, 3.0);\n        if(p > 0.008856) {\n            return p;\n        } else {\n            return (v - 16.0 / 116.0) / 7.787;\n        }\n    }\n    float s3_lab2rgb_curve2(float v) {\n        if(v > 0.0031308) {\n            return 1.055 * pow(v , (1.0 / 2.4)) - 0.055;\n        } else {\n            return 12.92 * v;\n        }\n    }\n    vec4 s3_lab2rgb(vec4 lab) {\n        float var_Y = (lab.x + 0.160) / 1.160;\n        float var_X = lab.y / 5.0 + var_Y;\n        float var_Z = var_Y - lab.z / 2.0;\n\n        var_X = s3_lab2rgb_curve(var_X) * 0.95047;\n        var_Y = s3_lab2rgb_curve(var_Y);\n        var_Z = s3_lab2rgb_curve(var_Z) * 1.08883;\n\n        float var_R = var_X *  3.2406 + var_Y * -1.5372 + var_Z * -0.4986;\n        float var_G = var_X * -0.9689 + var_Y *  1.8758 + var_Z *  0.0415;\n        float var_B = var_X *  0.0557 + var_Y * -0.2040 + var_Z *  1.0570;\n\n        var_R = s3_lab2rgb_curve2(var_R);\n        var_G = s3_lab2rgb_curve2(var_G);\n        var_B = s3_lab2rgb_curve2(var_B);\n\n        return vec4(var_R, var_G, var_B, lab.a);\n    }\n    vec4 s3_hcl2rgb(vec4 hcl) {\n        vec4 lab = vec4(hcl.z, hcl.y * cos(hcl.x), hcl.y * sin(hcl.x), hcl.a);\n        return s3_lab2rgb(lab);\n    }\n";c("lab2rgb",["Color"],"Color","s3_lab2rgb",y),c("hcl2rgb",["Color"],"Color","s3_hcl2rgb",y),c("abs",["float"],"float","abs"),c("sqrt",["float"],"float","sqrt"),c("exp",["float"],"float","exp"),c("log",["float"],"float","log"),c("sin",["float"],"float","sin"),c("cos",["float"],"float","cos"),c("tan",["float"],"float","tan"),c("asin",["float"],"float","asin"),c("acos",["float"],"float","acos"),c("atan",["float"],"float","atan"),c("atan2",["float","float"],"float","atan2"),c("abs",["int"],"int","abs"),c("min",["float","float"],"float","min"),c("max",["float","float"],"float","max"),c("ceil",["float"],"float","ceil"),c("floor",["float"],"float","floor"),c("mix",["float","float","float"],"float","mix"),c("mix",["Vector2","Vector2","float"],"Vector2","mix"),c("mix",["Vector3","Vector3","float"],"Vector3","mix"),c("mix",["Vector4","Vector4","float"],"Vector4","mix"),c("mix",["Color","Color","float"],"Color","mix"),s("clamp",["float"],"float",function(t){return"clamp("+t+", 0, 1)"}),l("float","int",function(t){return"int("+t+")"}),l("int","float",function(t){return"float("+t+")"}),s("array",["FloatArray","float"],"float",function(t,e){return"texture2D("+t+", vec2(("+e+" + 0.5) / float("+t+"_length), 0.5)).x"}),s("array",["Vector2Array","float"],"Vector2",function(t,e){return"texture2D("+t+", vec2(("+e+" + 0.5) / float("+t+"_length), 0.5)).xy"}),s("array",["Vector3Array","float"],"Vector3",function(t,e){return"texture2D("+t+", vec2(("+e+" + 0.5) / float("+t+"_length), 0.5)).xyz"}),s("array",["Vector4Array","float"],"Vector4",function(t,e){return"texture2D("+t+", vec2(("+e+" + 0.5) / float("+t+"_length), 0.5)).xyzw"}),s("array",["ColorArray","float"],"Color",function(t,e){return"texture2D("+t+", vec2(("+e+" + 0.5) / float("+t+"_length), 0.5)).rgba"}),s("image",["Image","Vector2"],"Color",function(t,e){return"texture2D("+t+", ("+e+" + 0.5) / vec2("+t+"_width, "+t+"_height))"}),s("image",["FloatImage","Vector2"],"float",function(t,e){return"texture2D("+t+", ("+e+" + 0.5) / vec2("+t+"_width, "+t+"_height)).x"}),s("image",["Vector2Image","Vector2"],"Vector2",function(t,e){return"texture2D("+t+", ("+e+" + 0.5) / vec2("+t+"_width, "+t+"_height)).xy"}),s("image",["Vector3Image","Vector2"],"Vector3",function(t,e){return"texture2D("+t+", ("+e+" + 0.5) / vec2("+t+"_width, "+t+"_height)).xyz"}),s("image",["Vector4Image","Vector2"],"Vector4",function(t,e){return"texture2D("+t+", ("+e+" + 0.5) / vec2("+t+"_width, "+t+"_height)).xyzw"}),s("image",["ColorImage","Vector2"],"Color",function(t,e){return"texture2D("+t+", ("+e+" + 0.5) / vec2("+t+"_width, "+t+"_height)).rgba"}),s("get_camera_position",[],"Vector3",function(){return"s3_get_camera_position()"}),s("get_camera_direction",["Vector3"],"Vector3",function(t){return"s3_get_camera_direction("+t+")"}),e.generateIntrinsicFunction=function(t,e){if(i.has(t))return a.has(t)?{code:i.get(t).apply(void 0,e),additionalCode:a.get(t)}:{code:i.get(t).apply(void 0,e),additionalCode:null};throw new Error("intrinsic function "+t+" is not defined.")}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1);e.compileProgram=function(t,e,n){var o=t.createShader(t.VERTEX_SHADER);t.shaderSource(o,e),t.compileShader(o);var i=t.getShaderParameter(o,t.COMPILE_STATUS);if(!i)throw console.log("Vertex shader code is:",e),new r.RuntimeError("could not compile vertex shader: "+t.getShaderInfoLog(o));var a=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(a,n),t.compileShader(a),!(i=t.getShaderParameter(a,t.COMPILE_STATUS)))throw console.log("Fragment shader code is:",n),new r.RuntimeError("could not compile fragment shader: "+t.getShaderInfoLog(a));var s=t.createProgram();if(t.attachShader(s,o),t.attachShader(s,a),t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))throw console.log("Vertex shader code is:",e),console.log("Fragment shader code is:",n),new r.RuntimeError("could not link shader: "+t.getProgramInfoLog(s));return s}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.getDefaultDevicePixelRatio=function(){return null!=window.devicePixelRatio?window.devicePixelRatio:1}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(1),o=n(50);e.isotype=function(t){var e=r.mark.custom();e.input("position","Vector2","[ 0, 0 ]"),e.input("size","float","1"),e.input("color","Color","[ 0, 0, 0, 1 ]");for(var n=function(t){var e=(new DOMParser).parseFromString(t,"image/svg+xml");function n(t,e){if(t instanceof Element&&t.tagName&&t.tagName.toLowerCase()==e)return[t];for(var r=[],o=0;o<t.children.length;o++)r=r.concat(n(t.children.item(o),e));return r}var r=n(e,"svg")[0],i=n(e,"polygon"),a=[];i.forEach(function(t){var e=t.getAttribute("points").split(/[, \t]/).map(function(t){return t.trim()}).filter(function(t){return""!=t}).map(function(t){return parseFloat(t)}),n=o(e),r="black";t.style.fill&&""!=t.style.fill&&(r=t.style.fill);for(var i=0;i<n.length;i+=3){var s=n[i+0],c=n[i+1],u=n[i+2],l={p1:[e[2*s],e[2*s+1]],p2:[e[2*c],e[2*c+1]],p3:[e[2*u],e[2*u+1]],color:r};a.push(l)}});var s=function(t){return null==t||""==t?0:t.match(/px$/)?parseFloat(t.substr(0,t.length-2)):t.match(/em$/)?parseFloat(t.substr(0,t.length-2)):parseFloat(t)};return{x:s(r.getAttribute("x")),y:s(r.getAttribute("y")),width:s(r.getAttribute("width")),height:s(r.getAttribute("height")),triangles:a}}(t),i=n.x+n.width/2,a=n.y+n.height/2,s=0,c=n.triangles;s<c.length;s++){var u=c[s];e.add("P2D.Triangle").attr("p1","position + Vector2("+(u.p1[0]-i)+", "+(u.p1[1]-a)+") * size").attr("p2","position + Vector2("+(u.p2[0]-i)+", "+(u.p2[1]-a)+") * size").attr("p3","position + Vector2("+(u.p3[0]-i)+", "+(u.p3[1]-a)+") * size").attr("color","color")}return e.compile()},e.version="0.2.3"},function(t,e,n){"use strict";function r(t,e,n){n=n||2;var r,s,c,u,l,h,v,m=e&&e.length,_=m?e[0]*n:t.length,y=o(t,0,_,n,!0),g=[];if(!y||y.next===y.prev)return g;if(m&&(y=function(t,e,n,r){var a,s,c,u,l,h=[];for(a=0,s=e.length;a<s;a++)c=e[a]*r,u=a<s-1?e[a+1]*r:t.length,(l=o(t,c,u,r,!1))===l.next&&(l.steiner=!0),h.push(d(l));for(h.sort(p),a=0;a<h.length;a++)f(h[a],n),n=i(n,n.next);return n}(t,e,y,n)),t.length>80*n){r=c=t[0],s=u=t[1];for(var x=n;x<_;x+=n)(l=t[x])<r&&(r=l),(h=t[x+1])<s&&(s=h),l>c&&(c=l),h>u&&(u=h);v=0!==(v=Math.max(c-r,u-s))?1/v:0}return a(y,g,n,r,s,v),g}function o(t,e,n,r,o){var i,a;if(o===A(t,e,n,r)>0)for(i=e;i<n;i+=r)a=V(i,t[i],t[i+1],a);else for(i=n-r;i>=e;i-=r)a=V(i,t[i],t[i+1],a);return a&&y(a,a.next)&&(w(a),a=a.next),a}function i(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!y(r,r.next)&&0!==_(r.prev,r,r.next))r=r.next;else{if(w(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function a(t,e,n,r,o,p,f){if(t){!f&&p&&function(t,e,n,r){var o=t;do{null===o.z&&(o.z=h(o.x,o.y,e,n,r)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==t);o.prevZ.nextZ=null,o.prevZ=null,function(t){var e,n,r,o,i,a,s,c,u=1;do{for(n=t,t=null,i=null,a=0;n;){for(a++,r=n,s=0,e=0;e<u&&(s++,r=r.nextZ);e++);for(c=u;s>0||c>0&&r;)0!==s&&(0===c||!r||n.z<=r.z)?(o=n,n=n.nextZ,s--):(o=r,r=r.nextZ,c--),i?i.nextZ=o:t=o,o.prevZ=i,i=o;n=r}i.nextZ=null,u*=2}while(a>1)}(o)}(t,r,o,p);for(var d,v,m=t;t.prev!==t.next;)if(d=t.prev,v=t.next,p?c(t,r,o,p):s(t))e.push(d.i/n),e.push(t.i/n),e.push(v.i/n),w(t),t=v.next,m=v.next;else if((t=v)===m){f?1===f?a(t=u(t,e,n),e,n,r,o,p,2):2===f&&l(t,e,n,r,o,p):a(i(t),e,n,r,o,p,1);break}}}function s(t){var e=t.prev,n=t,r=t.next;if(_(e,n,r)>=0)return!1;for(var o=t.next.next;o!==t.prev;){if(v(e.x,e.y,n.x,n.y,r.x,r.y,o.x,o.y)&&_(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function c(t,e,n,r){var o=t.prev,i=t,a=t.next;if(_(o,i,a)>=0)return!1;for(var s=o.x<i.x?o.x<a.x?o.x:a.x:i.x<a.x?i.x:a.x,c=o.y<i.y?o.y<a.y?o.y:a.y:i.y<a.y?i.y:a.y,u=o.x>i.x?o.x>a.x?o.x:a.x:i.x>a.x?i.x:a.x,l=o.y>i.y?o.y>a.y?o.y:a.y:i.y>a.y?i.y:a.y,p=h(s,c,e,n,r),f=h(u,l,e,n,r),d=t.prevZ,m=t.nextZ;d&&d.z>=p&&m&&m.z<=f;){if(d!==t.prev&&d!==t.next&&v(o.x,o.y,i.x,i.y,a.x,a.y,d.x,d.y)&&_(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,m!==t.prev&&m!==t.next&&v(o.x,o.y,i.x,i.y,a.x,a.y,m.x,m.y)&&_(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(;d&&d.z>=p;){if(d!==t.prev&&d!==t.next&&v(o.x,o.y,i.x,i.y,a.x,a.y,d.x,d.y)&&_(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;m&&m.z<=f;){if(m!==t.prev&&m!==t.next&&v(o.x,o.y,i.x,i.y,a.x,a.y,m.x,m.y)&&_(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function u(t,e,n){var r=t;do{var o=r.prev,i=r.next.next;!y(o,i)&&g(o,r,r.next,i)&&x(o,i)&&x(i,o)&&(e.push(o.i/n),e.push(r.i/n),e.push(i.i/n),w(r),w(r.next),r=t=i),r=r.next}while(r!==t);return r}function l(t,e,n,r,o,s){var c=t;do{for(var u=c.next.next;u!==c.prev;){if(c.i!==u.i&&m(c,u)){var l=b(c,u);return c=i(c,c.next),l=i(l,l.next),a(c,e,n,r,o,s),void a(l,e,n,r,o,s)}u=u.next}c=c.next}while(c!==t)}function p(t,e){return t.x-e.x}function f(t,e){if(e=function(t,e){var n,r=e,o=t.x,i=t.y,a=-1/0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){var s=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=o&&s>a){if(a=s,s===o){if(i===r.y)return r;if(i===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!n)return null;if(o===a)return n.prev;var c,u=n,l=n.x,p=n.y,f=1/0;r=n.next;for(;r!==u;)o>=r.x&&r.x>=l&&o!==r.x&&v(i<p?o:a,i,l,p,i<p?a:o,i,r.x,r.y)&&((c=Math.abs(i-r.y)/(o-r.x))<f||c===f&&r.x>n.x)&&x(r,t)&&(n=r,f=c),r=r.next;return n}(t,e)){var n=b(e,t);i(n,n.next)}}function h(t,e,n,r,o){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)*o)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*o)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function d(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function v(t,e,n,r,o,i,a,s){return(o-a)*(e-s)-(t-a)*(i-s)>=0&&(t-a)*(r-s)-(n-a)*(e-s)>=0&&(n-a)*(i-s)-(o-a)*(r-s)>=0}function m(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&g(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&x(t,e)&&x(e,t)&&function(t,e){var n=t,r=!1,o=(t.x+e.x)/2,i=(t.y+e.y)/2;do{n.y>i!=n.next.y>i&&n.next.y!==n.y&&o<(n.next.x-n.x)*(i-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)}function _(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function y(t,e){return t.x===e.x&&t.y===e.y}function g(t,e,n,r){return!!(y(t,e)&&y(n,r)||y(t,r)&&y(n,e))||_(t,e,n)>0!=_(t,e,r)>0&&_(n,r,t)>0!=_(n,r,e)>0}function x(t,e){return _(t.prev,t,t.next)<0?_(t,e,t.next)>=0&&_(t,t.prev,e)>=0:_(t,e,t.prev)<0||_(t,t.next,e)<0}function b(t,e){var n=new T(t.i,t.x,t.y),r=new T(e.i,e.x,e.y),o=t.next,i=e.prev;return t.next=e,e.prev=t,n.next=o,o.prev=n,r.next=n,n.prev=r,i.next=r,r.prev=i,r}function V(t,e,n,r){var o=new T(t,e,n);return r?(o.next=r.next,o.prev=r,r.next.prev=o,r.next=o):(o.prev=o,o.next=o),o}function w(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function T(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function A(t,e,n,r){for(var o=0,i=e,a=n-r;i<n;i+=r)o+=(t[a]-t[i])*(t[i+1]+t[a+1]),a=i;return o}t.exports=r,t.exports.default=r,r.deviation=function(t,e,n,r){var o=e&&e.length,i=o?e[0]*n:t.length,a=Math.abs(A(t,0,i,n));if(o)for(var s=0,c=e.length;s<c;s++){var u=e[s]*n,l=s<c-1?e[s+1]*n:t.length;a-=Math.abs(A(t,u,l,n))}var p=0;for(s=0;s<r.length;s+=3){var f=r[s]*n,h=r[s+1]*n,d=r[s+2]*n;p+=Math.abs((t[f]-t[d])*(t[h+1]-t[f+1])-(t[f]-t[h])*(t[d+1]-t[f+1]))}return 0===a&&0===p?0:Math.abs((p-a)/a)},r.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,o=0;o<t.length;o++){for(var i=0;i<t[o].length;i++)for(var a=0;a<e;a++)n.vertices.push(t[o][i][a]);o>0&&(r+=t[o-1].length,n.holes.push(r))}return n}}])});